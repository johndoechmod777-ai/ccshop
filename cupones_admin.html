<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Cupones - CCSHOP</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='text' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23ff0000'/><stop offset='100%' stop-color='%23cc0000'/></linearGradient></defs><path d='M8 8 L24 8 L24 24 L8 24 Z' transform='rotate(45 16 16)' fill='none' stroke='%23ff0000' stroke-width='1.5'/><text x='12' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text><text x='20' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden; 
            background: radial-gradient(circle at center, #050505 0%, #000000 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .main-title {
            color: #8B0000;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 
                0 0 20px rgba(139, 0, 0, 0.8),
                0 0 30px rgba(139, 0, 0, 0.3);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .subtitle {
            color: #ff4500;
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .user-info {
            color: #00ff00;
            text-align: center;
            margin-bottom: 15px;
            font-size: 12px;
            padding: 0 10px;
        }

        .panel-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .panel {
            border: 2px solid #330000;
            border-radius: 12px;
            box-shadow: 
                0 0 30px rgba(139, 0, 0, 0.4),
                inset 0 0 15px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            position: relative;
            padding: 20px;
            background: linear-gradient(135deg, #0f0f0f, #000000);
        }

        .panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: 
                linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.6), rgba(139, 0, 0, 0.8), transparent),
                linear-gradient(135deg, transparent, rgba(255, 0, 0, 0.3), transparent);
            background-size: 400% 400%, 200% 200%;
            z-index: -1;
            border-radius: 14px;
            animation: electricGlow 1.5s ease-in-out infinite alternate;
            opacity: 0.7;
            filter: blur(1px);
        }

        .panel-title {
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(139, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title i {
            color: #8B0000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: #999;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 700;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(139, 0, 0, 0.5);
            border-radius: 8px;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #ff4500;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #8B0000, #4B0000);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 
                0 0 15px rgba(139, 0, 0, 0.6),
                inset 0 0 8px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            width: 100%;
            margin-top: 5px;
        }

        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), rgba(139, 0, 0, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: scale(1.03);
            box-shadow: 
                0 0 20px rgba(139, 0, 0, 0.8),
                0 0 25px rgba(139, 0, 0, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn i {
            color: #00ff00;
            font-size: 13px;
            transition: transform 0.3s;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .btn:hover i {
            transform: translateX(3px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #333, #111);
        }

        .btn-success {
            background: linear-gradient(135deg, #008000, #004d00);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4500, #8B0000);
        }

        .coupons-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .coupon-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .coupon-item:hover {
            border-color: rgba(255, 69, 0, 0.5);
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
        }

        .coupon-code {
            color: #00ff00;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .coupon-message {
            color: #ccc;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .coupon-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: #999;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .coupon-status {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 8px;
        }

        .status-active {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .status-inactive {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4500;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .status-used {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.3);
        }

        .coupon-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            width: 100%;
        }

        .message-container {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            display: none;
            font-size: 13px;
        }

        .message-success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #00ff00;
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
        }

        .message-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff4500;
            text-shadow: 0 0 8px rgba(255, 69, 0, 0.5);
        }

        .access-denied {
            text-align: center;
            color: #ff4500;
            font-size: 16px;
            margin-top: 40px;
            display: none;
            padding: 0 15px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-number {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .stat-label {
            color: #999;
            font-size: 11px;
        }

        .debug-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 11px;
            color: #00ff00;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #8B0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.7);
        }

        @keyframes electricGlow {
            0% { 
                background-position: 0% 50%, 0% 0%; 
                opacity: 0.4;
                filter: blur(1px);
            }
            25% { 
                background-position: 100% 50%, 50% 100%; 
                opacity: 0.9;
                filter: blur(2px);
            }
            50% { 
                background-position: 0% 50%, 100% 0%; 
                opacity: 0.6;
                filter: blur(1px);
            }
            75% { 
                background-position: 100% 50%, 0% 100%; 
                opacity: 0.8;
                filter: blur(1.5px);
            }
            100% { 
                background-position: 0% 50%, 50% 0%; 
                opacity: 0.5;
                filter: blur(1px);
            }
        }

        /* Mejoras espec√≠ficas para m√≥viles muy peque√±os */
        @media (max-width: 360px) {
            .main-title {
                font-size: 28px;
            }
            
            .panel {
                padding: 15px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* Para tablets peque√±as */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .panel-container {
                grid-template-columns: 1fr 1fr;
                display: grid;
            }
            
            /* El nuevo panel de b√∫squeda se expandir√° en dos columnas */
            .panel-container > .panel:nth-child(3) {
                grid-column: 1 / -1; 
            }
            
            .coupon-actions {
                flex-direction: row;
            }
            
            .btn-small {
                width: auto;
            }
            
            .btn {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="accessDenied" class="access-denied">
            <h2>‚ùå ACCESO DENEGADO</h2>
            <p>No tienes permisos de administrador para acceder a esta p√°gina.</p>
            <button class="btn" onclick="window.location.href = 'cupones.html'" style="margin-top: 15px;">
                <i class="fas fa-arrow-left"></i> Volver a Cupones
            </button>
        </div>

        <div id="adminContent" style="display: none;">
            <div class="header">
                <h1 class="main-title">CCSHOP</h1>
                <p class="subtitle">üëë PANEL DE ADMINISTRACI√ìN üëë</p>
                <div class="user-info" id="userInfo">
                    <i class="fas fa-user-shield"></i> Cargando informaci√≥n...
                </div>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalCupones">0</div>
                    <div class="stat-label">Total Cupones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cuponesActivos">0</div>
                    <div class="stat-label">Cupones Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cuponesCanjeados">0</div>
                    <div class="stat-label">Canjeados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cuponesDisponibles">0</div>
                    <div class="stat-label">Disponibles</div>
                </div>
            </div>

            <div class="debug-panel" id="debugPanel">
                <strong>DEBUG CONSOLE:</strong>
                <div id="debugLog"></div>
            </div>

            <div class="panel-container">
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-plus-circle"></i> Crear Nuevo Cup√≥n</h2>
                    
                    <div class="form-group">
                        <label class="form-label">C√≥digo del Cup√≥n</label>
                        <input type="text" class="form-input" id="codigoCupon" placeholder="Ej: CCSHOP-123456" maxlength="20">
                        <button class="btn btn-secondary" id="btnGenerarCodigo">
                            <i class="fas fa-sync-alt"></i> Generar C√≥digo Autom√°tico
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor del Cup√≥n (USD)</label>
                        <select class="form-select" id="valorCupon">
                            <option value="10">$10 USD</option>
                            <option value="20">$20 USD</option>
                            <option value="30">$30 USD</option>
                            <option value="40">$40 USD</option>
                            <option value="50">$50 USD</option>
                            <option value="60">$60 USD</option>
                            <option value="70">$70 USD</option>
                            <option value="80">$80 USD</option>
                            <option value="90">$90 USD</option>
                            <option value="100">$100 USD</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Mensaje Personalizado / Instrucciones</label>
                        <textarea class="form-textarea" id="mensajeCupon" placeholder="Ej: ¬°FELICIDADES! Has ganado un cup√≥n de $X USD. Lee las instrucciones para canjear..."></textarea>
                        <button class="btn btn-secondary" id="btnInstruccionesAutomaticas">
                            <i class="fas fa-robot"></i> Generar Instrucciones Autom√°ticas
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estado del Cup√≥n</label>
                        <select class="form-select" id="estadoCupon">
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha de Expiraci√≥n (Opcional)</label>
                        <input type="datetime-local" class="form-input" id="fechaExpiracion">
                    </div>
                    
                    <button class="btn" id="btnCrearCupon" type="button">
                        <i class="fas fa-save"></i> Crear Cup√≥n
                    </button>
                    
                    <div id="messageAdmin" class="message-container"></div>
                </div>

                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-list"></i> Cupones Existentes</h2>
                    <div class="coupons-list" id="listaCupones">
                        </div>
                </div>
                
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-search"></i> Buscar y Gestionar Cupones de Usuario</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Email del Usuario Canjeador</label>
                        <input type="email" class="form-input" id="emailUsuarioBusqueda" placeholder="ej: usuario@dominio.com">
                    </div>

                    <button class="btn" id="btnBuscarCuponesUsuario" type="button">
                        <i class="fas fa-users"></i> Buscar Cupones Canjeados por Usuario
                    </button>
                    
                    <div id="listaCuponesUsuario" class="coupons-list" style="max-height: 250px; margin-top: 20px;">
                        <p style="color: #999; text-align: center; margin-top: 10px;">Ingresa un email y presiona buscar. (Solo buscar√° cupones marcados como 'canjeado' y con email de canje).</p>
                    </div>
                </div>
                </div>
        </div>
    </div>

    <button class="debug-toggle" onclick="toggleDebug()">üîß</button>

    <script>
        // =======================================================
        // CONFIGURACI√ìN FIREBASE
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD2tvQjJzh7ukTSyxzIQSo7GSpz7L8z11I",
            authDomain: "ccshop-realtime.firebaseapp.com",
            projectId: "ccshop-realtime",
            storageBucket: "ccshop-realtime.firebasestorage.app",
            messagingSenderId: "795626673305",
            appId: "1:795626673305:web:094dc265de1d4d1bc7d408",
            databaseURL: "https://ccshop-realtime-default-rtdb.firebaseio.com/"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // =======================================================
        // SISTEMA DE DEBUG
        // =======================================================
        function debugLog(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`üîß ${message}`);
        }

        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        // =======================================================
        // CORRECCI√ìN DE EVENT LISTENERS
        // =======================================================
        function configurarEventListeners() {
            // Bot√≥n crear cup√≥n
            const btnCrearCupon = document.getElementById('btnCrearCupon');
            if (btnCrearCupon) {
                btnCrearCupon.addEventListener('click', function() {
                    debugLog('üéØ BOT√ìN CREAR CUP√ìN PRESIONADO');
                    crearCupon();
                });
            }
            
            // Bot√≥n generar c√≥digo
            const btnGenerarCodigo = document.getElementById('btnGenerarCodigo');
            if (btnGenerarCodigo) {
                btnGenerarCodigo.addEventListener('click', function(e) {
                    e.preventDefault();
                    debugLog('üîÑ BOT√ìN GENERAR C√ìDIGO PRESIONADO');
                    generarCodigoAutomatico();
                });
            }

            // Bot√≥n generar instrucciones
            const btnInstruccionesAutomaticas = document.getElementById('btnInstruccionesAutomaticas');
            if (btnInstruccionesAutomaticas) {
                btnInstruccionesAutomaticas.addEventListener('click', function(e) {
                    e.preventDefault();
                    debugLog('ü§ñ BOT√ìN GENERAR INSTRUCCIONES PRESIONADO');
                    generarInstrucciones();
                });
            }
            
            // Bot√≥n buscar cupones por usuario
            const btnBuscarCuponesUsuario = document.getElementById('btnBuscarCuponesUsuario');
            if (btnBuscarCuponesUsuario) {
                btnBuscarCuponesUsuario.addEventListener('click', function(e) {
                    e.preventDefault();
                    const email = document.getElementById('emailUsuarioBusqueda').value.trim();
                    if (email) {
                        buscarCuponesPorUsuario(email.toLowerCase());
                    } else {
                        mostrarMensajeAdmin('‚ùå Por favor ingresa un email de usuario.', 'error');
                    }
                });
            }

            debugLog('‚úÖ Event listeners configurados correctamente');
        }

        // =======================================================
        // MONITOREO DE CONEXI√ìN FIREBASE
        // =======================================================
        function monitorearConexionFirebase() {
            const connectedRef = database.ref(".info/connected");
            
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    debugLog("‚úÖ Conectado a Firebase Realtime Database");
                } else {
                    debugLog("üîÑ Intentando reconectar a Firebase...");
                }
            });
        }

        // =======================================================
        // DETECCI√ìN DE ADMINISTRADOR - VERSI√ìN MEJORADA
        // =======================================================
        function verificarAdministrador() {
            debugLog('=== INICIANDO VERIFICACI√ìN ===');
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    debugLog(`‚úÖ USUARIO AUTENTICADO: ${user.email}`);
                    debugLog(`üîë UID: ${user.uid}`);
                    debugLog(`üìß Email verificado: ${user.emailVerified}`);
                    debugLog(`üöÄ Provider: ${user.providerData[0]?.providerId}`);
                    
                    try {
                        // BUSCAR EN TODOS LOS USUARIOS POR EMAIL (POR SI EL UID NO COINCIDE)
                        debugLog('üîç Buscando usuario en la base de datos...');
                        
                        const usersRef = database.ref('users');
                        const usersSnapshot = await usersRef.once('value');
                        
                        if (usersSnapshot.exists()) {
                            const allUsers = usersSnapshot.val();
                            debugLog(`üë• Usuarios en BD: ${Object.keys(allUsers).length}`);
                            
                            let usuarioEncontrado = null;
                            let uidCorrecto = null;
                            
                            // BUSCAR POR EMAIL EN TODOS LOS USUARIOS
                            Object.keys(allUsers).forEach(uid => {
                                const userData = allUsers[uid];
                                debugLog(`üìã ${uid}: ${userData.email} - admin:${userData.esAdmin}`);
                                
                                if (userData.email && userData.email.toLowerCase() === user.email.toLowerCase()) {
                                    usuarioEncontrado = userData;
                                    uidCorrecto = uid;
                                    debugLog(`üéØ USUARIO ENCONTRADO: ${uid} - ${userData.email}`);
                                }
                            });
                            
                            if (usuarioEncontrado) {
                                debugLog(`üìä Datos del usuario: ${JSON.stringify(usuarioEncontrado)}`);
                                
                                const esAdmin = usuarioEncontrado.esAdmin === true;
                                debugLog(`üëë ¬øEs admin?: ${esAdmin} (valor: ${usuarioEncontrado.esAdmin})`);
                                
                                if (esAdmin) {
                                    debugLog('üéâ ACCESO CONCEDIDO - Usuario es administrador');
                                    mostrarPanelAdmin(user);
                                    cargarCupones();
                                    configurarEventListeners();
                                } else {
                                    debugLog('‚ùå ACCESO DENEGADO - No es administrador');
                                    mostrarAccesoDenegado();
                                }
                            } else {
                                debugLog('‚ùå Usuario no encontrado en la base de datos');
                                // PERMITIR ACCESO SI EL EMAIL ES DE ADMIN
                                if (user.email.toLowerCase().includes('admin') || user.email === 'johndoechmod777@gmail.com') {
                                    debugLog('üéâ Acceso concedido por email de administrador');
                                    mostrarPanelAdmin(user);
                                    cargarCupones();
                                    configurarEventListeners();
                                } else {
                                    mostrarAccesoDenegado();
                                }
                            }
                        } else {
                            debugLog('‚ùå No hay usuarios en la base de datos');
                            // PERMITIR ACCESO A EMAILS DE ADMIN
                            if (user.email === 'johndoechmod777@gmail.com') {
                                debugLog('üéâ Acceso concedido a johndoechmod777@gmail.com');
                                mostrarPanelAdmin(user);
                                cargarCupones();
                                configurarEventListeners();
                            } else {
                                mostrarAccesoDenegado();
                            }
                        }
                        
                    } catch (error) {
                        debugLog(`üî• Error: ${error.message}`);
                        // EN CASO DE ERROR, PERMITIR ACCESO A johndoechmod777@gmail.com
                        if (user.email === 'johndoechmod777@gmail.com') {
                            debugLog('üéâ Acceso de emergencia concedido');
                            mostrarPanelAdmin(user);
                            cargarCupones();
                            configurarEventListeners();
                        } else {
                            mostrarAccesoDenegado();
                        }
                    }
                    
                } else {
                    debugLog('‚ùå Usuario no autenticado');
                    window.location.href = 'index.html';
                }
            });
        }
        function mostrarPanelAdmin(user) {
            document.getElementById('adminContent').style.display = 'block';
            document.getElementById('userInfo').innerHTML = 
                `<i class="fas fa-user-shield"></i> Conectado como: ${user.email} | Admin: ‚úÖ`;
        }

        function mostrarAccesoDenegado() {
            document.getElementById('accessDenied').style.display = 'block';
        }

        // =======================================================
        // GENERACI√ìN DE C√ìDIGOS
        // =======================================================
        function generarCodigoAutomatico() {
            const randomNum = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
            const codigo = `CCSHOP-${randomNum}`;
            document.getElementById('codigoCupon').value = codigo;
            debugLog(`C√≥digo generado: ${codigo}`);
        }

        // =======================================================
        // GENERACI√ìN AUTOM√ÅTICA DE INSTRUCCIONES
        // =======================================================
        function generarInstruccionesAutomaticas(valor) {
            const configuraciones = {
                10:  { deposito: 5,   balanceMin: 50,  balanceMax: 80 },
                20:  { deposito: 15,  balanceMin: 80,  balanceMax: 120 },
                30:  { deposito: 20,  balanceMin: 100, balanceMax: 150 },
                40:  { deposito: 25,  balanceMin: 120, balanceMax: 180 },
                50:  { deposito: 30,  balanceMin: 150, balanceMax: 200 },
                60:  { deposito: 35,  balanceMin: 180, balanceMax: 250 },
                70:  { deposito: 40,  balanceMin: 200, balanceMax: 280 },
                80:  { deposito: 45,  balanceMin: 220, balanceMax: 300 },
                90:  { deposito: 50,  balanceMin: 250, balanceMax: 350 },
                100: { deposito: 55,  balanceMin: 300, balanceMax: 400 }
            };

            const config = configuraciones[valor] || configuraciones[30];
            
            return `¬°FELICIDADES! üéâ Has canjeado un cup√≥n de $${valor} USD

üí≥ **INFORMACI√ìN DEL CUP√ìN:**
‚Ä¢ Valor facial: $${valor} USD
‚Ä¢ Balance incluido: $${config.balanceMin}-${config.balanceMax} USD
‚Ä¢ Dep√≥sito requerido: $${config.deposito} USD

üìã **PROCEDIMIENTO PARA OBTENER:**
1. Realiza un dep√≥sito de $${config.deposito} USD
2. Contacta a soporte con este c√≥digo
3. Recibir√°s tu tarjeta de $${valor} USD
4. Con balance extra de $${config.balanceMin}-${config.balanceMax} USD

‚ö° **¬°Tu inversi√≥n de $${config.deposito} USD se convierte en $${valor + config.balanceMin}-${valor + config.balanceMax} USD!**

üîí **Este cup√≥n es personal e intransferible.**
‚è∞ **V√°lido por 24 horas despu√©s del canje.**`;
        }

        /**
         * Funci√≥n para generar y mostrar las instrucciones autom√°ticas.
         */
        function generarInstrucciones() {
            const valorCupon = document.getElementById('valorCupon').value;
            const instrucciones = generarInstruccionesAutomaticas(parseInt(valorCupon));
            
            // SIEMPRE REEMPLAZAR el contenido del campo con las instrucciones autom√°ticas
            document.getElementById('mensajeCupon').value = instrucciones;
            
            debugLog(`‚úÖ Instrucciones generadas para valor $${valorCupon} USD`);
            debugLog(`üìù Instrucciones: ${instrucciones.substring(0, 100)}...`);
            mostrarMensajeAdmin('‚úÖ Instrucciones generadas autom√°ticamente. Puedes editarlas si lo deseas.', 'success');
            
            // Hacer scroll al campo de mensaje para que el admin las vea
            document.getElementById('mensajeCupon').scrollIntoView({ behavior: 'smooth' });
        }


        function validarFormatoCupon(codigo) {
            const regex = /^CCSHOP-\d{6}$/;
            const esValido = regex.test(codigo);
            debugLog(`Validando c√≥digo "${codigo}": ${esValido ? 'V√ÅLIDO' : 'INV√ÅLIDO'}`);
            return esValido;
        }

        // =======================================================
        // GESTI√ìN DE CUPONES (FUNCI√ìN REEMPLAZADA POR EL USUARIO)
        // =======================================================
        function crearCupon() {
            const codigo = document.getElementById('codigoCupon').value.trim().toUpperCase();
            const mensaje = document.getElementById('mensajeCupon').value.trim();
            const activo = document.getElementById('estadoCupon').value === 'true';
            const fechaExpiracion = document.getElementById('fechaExpiracion').value;
            const valor = parseInt(document.getElementById('valorCupon').value);
            
            debugLog('=== INICIANDO CREACI√ìN DE CUP√ìN ===');
            debugLog(`C√≥digo: ${codigo}`);
            debugLog(`Mensaje: ${mensaje}`);
            debugLog(`Activo: ${activo}`);
            debugLog(`Valor: $${valor} USD`);
            
            if (!codigo) {
                mostrarMensajeAdmin('‚ùå Por favor ingresa un c√≥digo para el cup√≥n', 'error');
                return;
            }
            
            if (!validarFormatoCupon(codigo)) {
                mostrarMensajeAdmin('‚ùå Formato de cup√≥n inv√°lido. Debe ser: CCSHOP-123456', 'error');
                return;
            }
            
            // üÜï GENERAR INSTRUCCIONES AUTOM√ÅTICAMENTE - SIEMPRE
            const instruccionesAutomaticas = generarInstruccionesAutomaticas(valor);
            debugLog(`‚úÖ Instrucciones generadas: ${instruccionesAutomaticas.substring(0, 50)}...`);
            
            // üÜï FORZAR que se guarden TODOS los campos, incluyendo valor e instrucciones
            const cuponData = {
                activo: activo,
                canjeado: false,
                mensaje: mensaje || `üéâ ¬°Cup√≥n v√°lido de $${valor} USD! üî• Revisa tu perfil para ver las instrucciones.`,
                fechaCreacion: new Date().toISOString(),
                creadoPor: auth.currentUser.email,
                creadoPorUID: auth.currentUser.uid,
                valor: valor, // üÜï ESTE CAMPO AHORA EST√Å INCLUIDO SIEMPRE
                instrucciones: instruccionesAutomaticas, // üÜï ESTE CAMPO AHORA EST√Å INCLUIDO SIEMPRE
                canjeadoPorEmail: null // Mantener el campo para la gesti√≥n de canjes
            };
            
            if (fechaExpiracion) {
                cuponData.fechaExpiracion = new Date(fechaExpiracion).toISOString();
            }
            
            debugLog('üîÑ Escribiendo en Firebase con TODOS los campos...');
            
            database.ref('cupones/' + codigo).set(cuponData)
                .then(() => {
                    debugLog(`‚úÖ Cup√≥n ${codigo} creado EXITOSAMENTE con valor e instrucciones`);
                    mostrarMensajeAdmin('‚úÖ Cup√≥n creado exitosamente con instrucciones', 'success');
                    limpiarFormulario();
                    cargarCupones();
                })
                .catch((error) => {
                    debugLog(`‚ùå Error al crear cup√≥n: ${error.message}`);
                    mostrarMensajeAdmin('‚ùå Error al crear el cup√≥n: ' + error.message, 'error');
                });
        }


        function limpiarFormulario() {
            document.getElementById('codigoCupon').value = '';
            document.getElementById('mensajeCupon').value = '';
            document.getElementById('estadoCupon').value = 'true';
            document.getElementById('fechaExpiracion').value = '';
            document.getElementById('valorCupon').value = '10'; 
            setTimeout(() => generarCodigoAutomatico(), 500);
        }

        function cargarCupones() {
            debugLog('Cargando cupones desde Firebase...');
            database.ref('cupones').once('value')
                .then((snapshot) => {
                    const listaCupones = document.getElementById('listaCupones');
                    listaCupones.innerHTML = '';
                    
                    let total = 0, activos = 0, canjeados = 0, disponibles = 0;
                    
                    if (snapshot.exists()) {
                        const cupones = snapshot.val();
                        debugLog(`Encontrados ${Object.keys(cupones).length} cupones`);
                        
                        Object.keys(cupones).forEach(codigo => {
                            const cupon = cupones[codigo];
                            total++;
                            if (cupon.activo) activos++;
                            if (cupon.canjeado) canjeados++;
                            if (cupon.activo && !cupon.canjeado) disponibles++;
                            
                            const estado = cupon.canjeado ? 'CANJEADO' : (cupon.activo ? 'ACTIVO' : 'INACTIVO');
                            const estadoClass = cupon.canjeado ? 'status-used' : (cupon.activo ? 'status-active' : 'status-inactive');
                            const expiracion = cupon.fechaExpiracion ? 
                                new Date(cupon.fechaExpiracion).toLocaleString() : 'Sin expiraci√≥n';
                            const valorTexto = cupon.valor ? `$${cupon.valor} USD` : 'N/A'; 
                            const canjeadoPor = cupon.canjeadoPorEmail || 'N/A'; 

                            const cuponItem = document.createElement('div');
                            cuponItem.className = 'coupon-item';
                            // C√ìDIGO COMPLETADO PARA MOSTRAR LA INFORMACI√ìN DEL CUP√ìN
                            cuponItem.innerHTML = `
                                <div class="coupon-code">${codigo}</div>
                                <div class="coupon-message">${(cupon.mensaje || 'Sin mensaje personalizado').replace(/\n/g, '<br>')}</div>
                                <div class="coupon-details">
                                    <span><strong>Valor:</strong> ${valorTexto}</span> <span><strong>Creado por:</strong> ${cupon.creadoPor || 'N/A'}</span>
                                    <span><strong>Canjeado por:</strong> ${canjeadoPor}</span>
                                    <span><strong>Creado:</strong> ${new Date(cupon.fechaCreacion).toLocaleString()}</span>
                                    <span><strong>Expira:</strong> ${expiracion}</span>
                                </div>
                                <div class="coupon-details">
                                    <span class="coupon-status ${estadoClass}">${estado}</span>
                                    <span><strong>Canjeado:</strong> ${cupon.canjeado ? 'S√≠' : 'No'}</span>
                                </div>
                                <div class="coupon-actions">
                                    <button class="btn btn-small ${cupon.activo ? 'btn-danger' : 'btn-success'}" onclick="toggleCupon('${codigo}', ${!cupon.activo})">
                                        ${cupon.activo ? 'Desactivar' : 'Activar'}
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="resetearCupon('${codigo}')" ${!cupon.canjeado ? 'disabled' : ''}>
                                        Resetear
                                    </button>
                                    <button class="btn btn-small btn-danger" onclick="eliminarCupon('${codigo}')">
                                        Eliminar
                                    </button>
                                </div>
                            `;
                            listaCupones.appendChild(cuponItem);
                        });
                    } else {
                        debugLog('No se encontraron cupones');
                        listaCupones.innerHTML = '<p style="color: #999; text-align: center;">No hay cupones creados</p>';
                    }
                    
                    document.getElementById('totalCupones').textContent = total;
                    document.getElementById('cuponesActivos').textContent = activos;
                    document.getElementById('cuponesCanjeados').textContent = canjeados;
                    document.getElementById('cuponesDisponibles').textContent = disponibles;
                    debugLog(`Estad√≠sticas: Total=${total}, Activos=${activos}, Canjeados=${canjeados}, Disponibles=${disponibles}`);
                })
                .catch((error) => {
                    debugLog(`‚ùå Error al cargar cupones: ${error.message}`);
                    document.getElementById('listaCupones').innerHTML = '<p style="color: #ff4500; text-align: center;">Error al cargar cupones</p>';
                });
        }

        // =======================================================
        // GESTI√ìN DE CUPONES DE USUARIO (NUEVO)
        // =======================================================
        function buscarCuponesPorUsuario(email) {
            debugLog(`üîç Buscando cupones canjeados por usuario con email: ${email}`);
            const listaCuponesUsuario = document.getElementById('listaCuponesUsuario');
            listaCuponesUsuario.innerHTML = '<p style="color: #999; text-align: center; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Buscando...</p>';

            database.ref('cupones').once('value')
                .then((snapshot) => {
                    const cupones = snapshot.val();
                    const cuponesEncontrados = [];
                    
                    if (cupones) {
                        Object.keys(cupones).forEach(codigo => {
                            const cupon = cupones[codigo];
                            // Filtrar por cupones canjeados y que contengan el email del usuario.
                            if (cupon.canjeado && cupon.canjeadoPorEmail && cupon.canjeadoPorEmail.toLowerCase() === email) {
                                cuponesEncontrados.push({ codigo, ...cupon });
                            }
                        });
                    }

                    listaCuponesUsuario.innerHTML = ''; // Limpiar el contenido

                    if (cuponesEncontrados.length > 0) {
                        debugLog(`‚úÖ Encontrados ${cuponesEncontrados.length} cupones para ${email}`);
                        cuponesEncontrados.forEach(cupon => {
                            const expiracion = cupon.fechaExpiracion ? 
                                new Date(cupon.fechaExpiracion).toLocaleString() : 'Sin expiraci√≥n';
                            const valorTexto = cupon.valor ? `$${cupon.valor} USD` : 'N/A';
                            
                            const cuponItem = document.createElement('div');
                            cuponItem.className = 'coupon-item';
                            cuponItem.innerHTML = `
                                <div class="coupon-code">${cupon.codigo}</div>
                                <div class="coupon-message">Valor: ${valorTexto}</div>
                                <div class="coupon-details">
                                    <span><strong>Canjeado por:</strong> ${cupon.canjeadoPorEmail}</span>
                                    <span><strong>Mensaje:</strong> ${(cupon.mensaje || 'Sin mensaje personalizado').replace(/\n/g, '<br>')}</span>
                                    <span><strong>Expira:</strong> ${expiracion}</span>
                                </div>
                                <div class="coupon-actions">
                                    <button class="btn btn-small btn-danger" onclick="removerCanjeDeCupon('${cupon.codigo}', '${email}')">
                                        <i class="fas fa-trash-alt"></i> Eliminar Canje
                                    </button>
                                </div>
                            `;
                            listaCuponesUsuario.appendChild(cuponItem);
                        });
                        mostrarMensajeAdmin(`‚úÖ ${cuponesEncontrados.length} cupones encontrados para ${email}`, 'success');

                    } else {
                        debugLog(`‚ùå No se encontraron cupones canjeados por ${email}`);
                        listaCuponesUsuario.innerHTML = `<p style="color: #999; text-align: center; margin-top: 10px;">No se encontraron cupones canjeados por el email: <strong>${email}</strong></p>`;
                    }
                })
                .catch((error) => {
                    debugLog(`üî• Error al buscar cupones de usuario: ${error.message}`);
                    listaCuponesUsuario.innerHTML = `<p style="color: #ff4500; text-align: center; margin-top: 10px;">Error al buscar cupones: ${error.message}</p>`;
                });
        }

        function removerCanjeDeCupon(codigo, emailBusqueda) {
            if (confirm(`¬øEst√°s seguro de ELIMINAR el canje del cup√≥n ${codigo} para el usuario ${emailBusqueda}? El cup√≥n volver√° a estar disponible.`)) {
                debugLog(`üóëÔ∏è Removiendo canje de cup√≥n: ${codigo} para ${emailBusqueda}`);
                
                // Se revierte el estado de canje del cup√≥n
                database.ref('cupones/' + codigo).update({ 
                    canjeado: false,
                    canjeadoPorEmail: null 
                })
                .then(() => {
                    debugLog(`‚úÖ Canje de cup√≥n ${codigo} revertido.`);
                    mostrarMensajeAdmin(`‚úÖ Canje de cup√≥n ${codigo} revertido para ${emailBusqueda}.`, 'success');
                    // Recargar la lista de cupones general y la lista de b√∫squeda del usuario.
                    cargarCupones();
                    buscarCuponesPorUsuario(emailBusqueda); 
                })
                .catch((error) => {
                    debugLog(`‚ùå Error al remover canje de cup√≥n: ${error.message}`);
                    mostrarMensajeAdmin('‚ùå Error al remover el canje del cup√≥n', 'error');
                });
            }
        }
        
        // =======================================================
        // ACCIONES DE CUPONES (EXISTENTES)
        // =======================================================
        function toggleCupon(codigo, nuevoEstado) {
            debugLog(`üîÑ Toggle Cup√≥n: ${codigo} a activo: ${nuevoEstado}`);
            database.ref('cupones/' + codigo).update({ activo: nuevoEstado })
                .then(() => {
                    debugLog(`‚úÖ Cup√≥n ${codigo} actualizado a ${nuevoEstado ? 'ACTIVO' : 'INACTIVO'}`);
                    mostrarMensajeAdmin(`‚úÖ Cup√≥n ${codigo} actualizado a ${nuevoEstado ? 'activo' : 'inactivo'}`, 'success');
                    cargarCupones();
                })
                .catch((error) => {
                    debugLog(`‚ùå Error al cambiar estado: ${error.message}`);
                    mostrarMensajeAdmin('‚ùå Error al cambiar el estado del cup√≥n', 'error');
                });
        }

        function resetearCupon(codigo) {
            if (confirm(`¬øEst√°s seguro de resetear el cup√≥n ${codigo}? Esto lo marcar√° como NO canjeado y eliminar√° el registro de canjeador.`)) {
                debugLog(`üîÑ Reseteando Cup√≥n: ${codigo}`);
                
                // Resetea el estado y elimina el registro de canje
                database.ref('cupones/' + codigo).update({ canjeado: false, canjeadoPorEmail: null })
                    .then(() => {
                        debugLog(`‚úÖ Cup√≥n ${codigo} reseteado a NO canjeado.`);
                        mostrarMensajeAdmin(`‚úÖ Cup√≥n ${codigo} reseteado a NO canjeado.`, 'success');
                        // Advertencia: El saldo del usuario que lo canje√≥ debe revertirse manualmente.
                        cargarCupones();
                    })
                    .catch((error) => {
                        debugLog(`‚ùå Error al resetear cup√≥n: ${error.message}`);
                        mostrarMensajeAdmin('‚ùå Error al resetear el cup√≥n', 'error');
                    });
            }
        }

        function eliminarCupon(codigo) {
            if (confirm(`¬øEst√°s seguro de eliminar permanentemente el cup√≥n ${codigo}?`)) {
                debugLog(`üóëÔ∏è Eliminando cup√≥n: ${codigo}`);
                database.ref('cupones/' + codigo).remove()
                    .then(() => {
                        debugLog(`‚úÖ Cup√≥n ${codigo} eliminado`);
                        mostrarMensajeAdmin('‚úÖ Cup√≥n eliminado', 'success');
                        cargarCupones();
                    })
                    .catch((error) => {
                        debugLog(`‚ùå Error al eliminar cup√≥n: ${error.message}`);
                        mostrarMensajeAdmin('‚ùå Error al eliminar el cup√≥n', 'error');
                    });
            }
        }

        function mostrarMensajeAdmin(mensaje, tipo) {
            const messageAdmin = document.getElementById('messageAdmin');
            messageAdmin.textContent = mensaje;
            messageAdmin.className = 'message-container';
            messageAdmin.classList.add(tipo === 'success' ? 'message-success' : 'message-error');
            messageAdmin.style.display = 'block';
            
            setTimeout(() => {
                messageAdmin.style.display = 'none';
            }, 5000);
        }

        // =======================================================
        // INICIALIZACI√ìN
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('üëë Iniciando Panel de Administraci√≥n M√≥vil');
            monitorearConexionFirebase();
            verificarAdministrador();
            generarCodigoAutomatico();
        });
    </script>
</body>
</html>
