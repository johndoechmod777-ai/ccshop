<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n - CCshop</title>
    
    <!-- FAVICON SVG AGREGADO -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='text' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23ff0000'/><stop offset='100%' stop-color='%23cc0000'/></linearGradient></defs><path d='M8 8 L24 8 L24 24 L8 24 Z' transform='rotate(45 16 16)' fill='none' stroke='%23ff0000' stroke-width='1.5'/><text x='12' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text><text x='20' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000000; 
            font-family: Arial, sans-serif; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative; 
            overflow-x: hidden; 
        }

        .background-video { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover; 
            z-index: -1; 
        }

        .content {
            text-align: center;
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .subtitle { 
            color: #ff0000; 
            font-size: 18px; 
            margin-bottom: 30px; 
            line-height: 1.3; 
        }

        .verification-title { 
            color: #ff0000; 
            font-size: 24px; 
            margin: 20px 0; 
            font-weight: bold; 
            text-shadow: 0 2px 8px rgba(0,0,0,0.9);
        }

        .captcha-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .captcha-title {
            color: #ff0000;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .math-question {
            font-size: 32px;
            font-weight: bold;
            color: #ff0000;
            margin: 20px 0;
            display: inline-block;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            background-color: rgba(0, 0, 0, 0.3);
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
        }

        .captcha-input {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            margin: 15px 0;
            text-align: center;
        }

        .captcha-input:focus {
            outline: none;
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }

        .verify-button { 
            background: rgba(255, 0, 0, 0.7); 
            color: white; 
            padding: 15px 40px; 
            font-size: 18px; 
            font-weight: bold; 
            border-radius: 40px; 
            cursor: pointer; 
            letter-spacing: 2px; 
            transition: all 0.3s ease; 
            margin-top: 15px;
            border: none;
        }

        .verify-button:hover { 
            background: rgba(255, 0, 0, 0.9); 
        }

        .message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
        }

        .success {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            display: none;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
            display: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ff0000;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-info { 
            position: fixed; 
            top: 10px; 
            left: 10px; 
            background: rgba(0, 0, 0, 0.6); 
            color: #ff0000; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            z-index: 1002; 
        }

        .user-name {
            display: inline-block;
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
            font-weight: bold;
        }
        
        .logout-button { 
            background: transparent; 
            color: #ff4444; 
            border: 1px solid #ff4444; 
            padding: 4px 8px; 
            font-size: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-left: 8px; 
            vertical-align: middle;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .logout-button:hover { 
            background: rgba(255, 68, 68, 0.2); 
            transform: scale(1.05);
        }

        .instructions {
            color: #ff0000;
            font-size: 16px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .refresh-button {
            background: transparent;
            color: #ff4444;
            border: 1px solid #ff4444;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .refresh-button:hover {
            background: rgba(255, 68, 68, 0.2);
        }
        
        .security-warning {
            color: #ff9900;
            font-size: 12px;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <video class="background-video" autoplay muted loop id="bgVideo">
        <source src="log.mp4" type="video/mp4">
    </video>

    <div class="user-info" id="userInfo" style="display: none;">
        <span class="user-name" id="userName"></span>
        <button class="logout-button" onclick="logout()">Cerrar</button>
    </div>

    <div class="content">
        <p class="subtitle">VERIFICACI√ìN DE SEGURIDAD</p>
        
        <div class="verification-title">COMPLETE LA VERIFICACI√ìN</div>
        
        <p class="instructions">Para acceder a la tienda, resuelva la siguiente operaci√≥n matem√°tica:</p>
        
        <div class="captcha-container">
            <div class="captcha-title">Resuelva la siguiente operaci√≥n:</div>
            <div class="math-question" id="mathQuestion"></div>
            <input type="text" class="captcha-input" id="captchaInput" placeholder="Respuesta" maxlength="3" autocomplete="off">
            <p class="security-warning">‚ö†Ô∏è Verificaci√≥n de seguridad activada</p>
        </div>

        <button class="refresh-button" onclick="generateSecureCaptcha()">üîÑ Nueva operaci√≥n</button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #ff0000; margin-top: 15px; font-weight: bold;">Verificando identidad...</p>
        </div>

        <button class="verify-button" onclick="verifySecureCaptcha()">VERIFICAR IDENTIDAD</button>
        <div class="message success" id="successMessage">‚úì Verificaci√≥n exitosa. Redirigiendo...</div>
        <div class="message error" id="errorMessage">‚úó Respuesta incorrecta. Intente nuevamente.</div>
    </div>

    <script>
        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD2tvQjJzh7ukTSyxzIQSo7GSpz7L8z11I",
            authDomain: "ccshop-realtime.firebaseapp.com",
            projectId: "ccshop-realtime",
            storageBucket: "ccshop-realtime.firebasestorage.app",
            messagingSenderId: "795626673305",
            appId: "1:795626673305:web:094dc265de1d4d1bc7d408"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Variables de seguridad
        let correctAnswer = 0;
        let captchaHash = '';
        let verificationAttempts = 0;
        const MAX_ATTEMPTS = 5;


        // =======================================================
        // === SISTEMA TELEGRAM PARA NOTIFICACIONES DE SEGURIDAD ===
        // =======================================================
        const TELEGRAM_BOT_TOKEN = '8592786208:AAH-Sl-umo_XKUknYDQNeM2TYl6iZcb17yA'; 
        const TELEGRAM_CHAT_ID = '8123415545'; 

        async function enviarNotificacionTelegram(mensaje) {
            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: mensaje,
                        parse_mode: 'HTML'
                    })
                });
            } catch (error) {
                console.error('Error al enviar notificaci√≥n Telegram:', error);
            }
        }

        // Funci√≥n simplificada y as√≠ncrona para detectar IP
        async function detectarIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'No detectada';
            }
        }

        // Funci√≥n para notificar verificaci√≥n exitosa (FORMATO MEJORADO)
        async function notificarVerificacionExitosa(user) {
            try {
                const ip = await detectarIP();
                
                const mensaje = `
üü¢ <b>VERIFICACI√ìN EXITOSA</b>
üìÅ P√°gina: <code>verificacion.html</code>

üë§ <b>Usuario:</b> <code>${user.displayName || 'Usuario An√≥nimo'}</code>
üìß <b>Email:</b> <code>${user.email || 'No proporcionado'}</code>
üÜî <b>UID:</b> <code>${user.uid.substring(0, 12)}...</code>
üåê <b>IP:</b> <code>${ip}</code>
üì± <b>Dispositivo:</b> ${navigator.platform}
üïí <b>Hora:</b> ${new Date().toLocaleString('es-ES')}

‚úÖ <i>Acceso concedido al sistema</i>
                `;
                
                await enviarNotificacionTelegram(mensaje);
            } catch (error) {
                console.error('Error en notificarVerificacionExitosa:', error);
            }
        }

        // Funci√≥n para notificar intento fallido (FORMATO MEJORADO)
        async function notificarIntentoFallido(user, attempts) {
            try {
                const ip = await detectarIP();
                
                const mensaje = `
üî¥ <b>INTENTO FALLIDO</b>
üö® Intentos: <b>${attempts}/${MAX_ATTEMPTS}</b>
üìÅ P√°gina: <code>verificacion.html</code>

üë§ <b>Usuario:</b> <code>${user.displayName || 'Usuario An√≥nimo'}</code>
üìß <b>Email:</b> <code>${user.email || 'No proporcionado'}</code>
üÜî <b>UID:</b> <code>${user.uid.substring(0, 12)}...</code>
üåê <b>IP:</b> <code>${ip}</code>
üìñ <b>Pregunta:</b> <code>${document.getElementById('mathQuestion').textContent}</code>
üïí <b>Hora:</b> ${new Date().toLocaleString('es-ES')}

üõë <i>Verificaci√≥n incorrecta</i>
                `;
                
                await enviarNotificacionTelegram(mensaje);
            } catch (error) {
                console.error('Error en notificarIntentoFallido:', error);
            }
        }


        // =======================================================
        // CAPTCHA MEGA-SEGURO CON GENERACI√ìN DIN√ÅMICA
        // =======================================================
        function generateSecureCaptcha() {
            const operations = [];
            
            // Generar 50 operaciones aleatorias
            for (let i = 0; i < 50; i++) {
                const type = Math.floor(Math.random() * 4); // 0: suma, 1: resta, 2: multiplicaci√≥n, 3: divisi√≥n
                
                let num1, num2, question, answer;
                
                switch(type) {
                    case 0: // SUMA
                        num1 = Math.floor(Math.random() * 30) + 1;
                        num2 = Math.floor(Math.random() * 30) + 1;
                        question = `¬øCu√°nto es ${num1} + ${num2}?`;
                        answer = num1 + num2;
                        break;
                        
                    case 1: // RESTA
                        num1 = Math.floor(Math.random() * 40) + 10;
                        num2 = Math.floor(Math.random() * 10) + 1;
                        question = `¬øCu√°nto es ${num1} - ${num2}?`;
                        answer = num1 - num2;
                        break;
                        
                    case 2: // MULTIPLICACI√ìN
                        num1 = Math.floor(Math.random() * 12) + 1;
                        num2 = Math.floor(Math.random() * 12) + 1;
                        question = `¬øCu√°nto es ${num1} √ó ${num2}?`;
                        answer = num1 * num2;
                        break;
                        
                    case 3: // DIVISI√ìN
                        num2 = Math.floor(Math.random() * 10) + 2;
                        answer = Math.floor(Math.random() * 10) + 1;
                        num1 = num2 * answer; // Asegura que el resultado sea un entero
                        question = `¬øCu√°nto es ${num1} √∑ ${num2}?`;
                        break;
                }
                
                operations.push({ q: question, a: answer });
            }
            
            // Seleccionar una de las 50 operaciones generadas
            const randomOp = operations[Math.floor(Math.random() * operations.length)];
            correctAnswer = randomOp.a;
            
            // Hash de seguridad ultra-seguro (incluye m√°s datos para mayor unicidad)
            captchaHash = btoa(`${correctAnswer}${Date.now()}${Math.random()}${navigator.userAgent}${screen.width}`).substring(3, 25);
            
            document.getElementById('mathQuestion').textContent = randomOp.q;
            document.getElementById('captchaInput').value = '';
            
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // =======================================================
        // VERIFICACI√ìN MEJORADA CON M√öLTIPLES CAPAS
        // =======================================================
        function verifySecureCaptcha() {
            const user = auth.currentUser;
            
            // PRIMERA CAPA: Verificar que el usuario est√© autenticado
            if (!user) {
                alert('Error: Sesi√≥n no v√°lida. Redirigiendo...');
                window.location.href = 'index.html';
                return;
            }
            
            // SEGUNDA CAPA: L√≠mite de intentos
            verificationAttempts++;
            if (verificationAttempts > MAX_ATTEMPTS) {
                alert('‚ùå Demasiados intentos fallidos. Cerrando sesi√≥n por seguridad.');
                // üö® NOTIFICACI√ìN TELEGRAM - CIERRE POR EXCESO DE INTENTOS
                notificarIntentoFallido(user, verificationAttempts); 
                logout();
                return;
            }
            
            const loading = document.getElementById('loading');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            // Mostrar loading
            loading.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Simular procesamiento de seguridad
            setTimeout(() => {
                loading.style.display = 'none';
                
                const userAnswer = parseInt(document.getElementById('captchaInput').value);
                
                // TERCERA CAPA: Verificaci√≥n m√∫ltiple
                const isAnswerCorrect = userAnswer === correctAnswer;
                const isHashValid = captchaHash.length > 0;
                const isUserValid = user && user.uid;
                
                if (isAnswerCorrect && isHashValid && isUserValid) {
                    successMessage.style.display = 'block';
                    verificationAttempts = 0; // Resetear intentos
                    
                    // ‚úÖ CORRECCI√ìN CR√çTICA: GUARDAR ESTADO EN LOCALSTORAGE
                    localStorage.setItem('passedCaptcha', 'true');
                    localStorage.setItem('userAuthenticated', 'true');
                    
                    // üîî NOTIFICACI√ìN TELEGRAM + REDIRECCI√ìN (Prioriza la redirecci√≥n)
                    notificarVerificacionExitosa(user).then(() => {
                        // Redirigir despu√©s de enviar la notificaci√≥n
                        setTimeout(() => {
                            window.location.href = 'anuncio.html';
                        }, 2000);
                    }).catch(() => {
                        // Redirigir incluso si falla la promesa de notificaci√≥n
                        setTimeout(() => {
                            window.location.href = 'anuncio.html';
                        }, 2000);
                    });
                    
                } else {
                    errorMessage.style.display = 'block';
                    errorMessage.innerHTML = `‚úó Verificaci√≥n fallida (Intento ${verificationAttempts}/${MAX_ATTEMPTS})`;
                    
                    // üö® NOTIFICACI√ìN TELEGRAM - INTENTO FALLIDO
                    notificarIntentoFallido(user, verificationAttempts);

                    // Generar nueva operaci√≥n despu√©s de un error
                    setTimeout(() => {
                        generateSecureCaptcha();
                    }, 1500);
                }
            }, 1500);
        }

        // Permitir verificaci√≥n con Enter
        document.getElementById('captchaInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifySecureCaptcha();
            }
        });

        function updateUserInfo(user) {
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            
            // Acortar nombre si es muy largo
            let displayName = user.displayName || 'Usuario Verificado';
            if (displayName.length > 20) {
                displayName = displayName.substring(0, 17) + '...';
            }
            
            userName.textContent = displayName;
            userInfo.style.display = 'block';
        }

        function logout() {
            auth.signOut().then(() => {
                // Limpiar todo y redirigir
                verificationAttempts = 0;
                correctAnswer = 0;
                captchaHash = '';
                localStorage.removeItem('passedCaptcha');
                localStorage.removeItem('userAuthenticated');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error al cerrar sesi√≥n:', error);
                window.location.href = 'index.html';
            });
        }

        // OBSERVADOR MEJORADO DE AUTENTICACI√ìN
        auth.onAuthStateChanged((user) => {
            if (user) {
                updateUserInfo(user);
                generateSecureCaptcha(); // Solo generar CAPTCHA si el usuario es v√°lido
            } else {
                // Si no hay usuario, redirigir inmediatamente al login
                window.location.href = 'index.html';
            }
        });

        // PROTECCI√ìN CONTRA INSPECCI√ìN
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });

        // Inicializar seguridad al cargar
        window.onload = function() {
            console.log('üîê Sistema de verificaci√≥n seguro inicializado');
        };
    </script>
</body>
</html>

