<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cupones - CCSHOP</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='text' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23ff0000'/><stop offset='100%' stop-color='%23cc0000'/></linearGradient></defs><path d='M8 8 L24 8 L24 24 L8 24 Z' transform='rotate(45 16 16)' fill='none' stroke='%23ff0000' stroke-width='1.5'/><text x='12' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text><text x='20' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos CSS mejorados para un tema oscuro/rojo vibrante */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden; 
            background: radial-gradient(circle at center, #050505 0%, #000000 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .main-title {
            color: #8B0000; /* Rojo Oscuro */
            font-size: 32px;
            font-weight: 700;
            text-shadow: 
                0 0 20px rgba(139, 0, 0, 0.8),
                0 0 30px rgba(139, 0, 0, 0.3);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .subtitle {
            color: #ff4500; /* Naranja Rojo */
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .user-info {
            color: #00ff00; /* Verde Ne√≥n */
            text-align: center;
            margin-bottom: 15px;
            font-size: 12px;
            padding: 0 10px;
        }

        .panel {
            border: 2px solid #330000;
            border-radius: 12px;
            box-shadow: 
                0 0 30px rgba(139, 0, 0, 0.4),
                inset 0 0 15px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            position: relative;
            padding: 20px;
            background: linear-gradient(135deg, #0f0f0f, #000000);
            margin-bottom: 20px;
        }

        /* Efecto de brillo */
        .panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: 
                linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.6), rgba(139, 0, 0, 0.8), transparent),
                linear-gradient(135deg, transparent, rgba(255, 0, 0, 0.3), transparent);
            background-size: 400% 400%, 200% 200%;
            z-index: -1;
            border-radius: 14px;
            animation: electricGlow 1.5s ease-in-out infinite alternate;
            opacity: 0.7;
            filter: blur(1px);
        }

        .panel-title {
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(139, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title i {
            color: #8B0000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: #999;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 700;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(139, 0, 0, 0.5);
            border-radius: 8px;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff4500;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.5);
        }

        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #8B0000, #4B0000);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 
                0 0 15px rgba(139, 0, 0, 0.6),
                inset 0 0 8px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            width: 100%;
            margin-top: 5px;
        }

        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), rgba(139, 0, 0, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: scale(1.03);
            box-shadow: 
                0 0 20px rgba(139, 0, 0, 0.8),
                0 0 25px rgba(139, 0, 0, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn i {
            color: #00ff00;
            font-size: 13px;
            transition: transform 0.3s;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .btn:hover i {
            transform: translateX(3px);
        }
        
        /* Estilo espec√≠fico para el nuevo bot√≥n de tienda, usando el color base de los botones normales */
        .btn-shop {
            background: linear-gradient(135deg, #8B0000, #4B0000); 
            margin-top: 10px; /* Separaci√≥n del bot√≥n de canjear */
        }
        
        /* Estilo para el bot√≥n de eliminar historial */
        .btn-delete {
            background: linear-gradient(135deg, #cc0000, #800000);
            box-shadow: 
                0 0 15px rgba(204, 0, 0, 0.6),
                inset 0 0 8px rgba(0, 0, 0, 0.5);
            margin-top: 10px; /* Separaci√≥n de los botones anteriores */
        }
        
        .btn-delete i {
            color: #ffcccc; 
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #008000, #004d00);
        }

        .coupons-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .coupon-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
            cursor: pointer; /* Lo hace clickable */
        }

        .coupon-item:hover {
            border-color: rgba(255, 69, 0, 0.5);
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
            background: rgba(139, 0, 0, 0.1); /* Ligero hover color */
        }

        .coupon-code {
            color: #00ff00;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 5px;
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .coupon-message {
            color: #ccc;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .coupon-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: #999;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .coupon-status {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 8px;
        }

        .status-used {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid rgba(255, 165, 0, 0.3);
        }

        .message-container {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            display: none;
            font-size: 13px;
        }

        .message-success {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #00ff00;
            text-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
        }

        .message-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff4500;
            text-shadow: 0 0 8px rgba(255, 69, 0, 0.5);
        }

        .access-denied {
            text-align: center;
            color: #ff4500;
            font-size: 16px;
            margin-top: 40px;
            display: none;
            padding: 0 15px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: 1fr; /* AJUSTADO para un solo elemento */
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-number {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .stat-label {
            color: #999;
            font-size: 11px;
        }

        .admin-link {
            text-align: center;
            margin-top: 15px;
        }

        .admin-link a {
            color: #ff4500;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
        }

        .admin-link a:hover {
            text-decoration: underline;
        }
        
        /* Estilos para el Modal de Detalle de Cup√≥n */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; /* Inicialmente oculto */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
            border: 2px solid #8B0000;
            border-radius: 12px;
            padding: 30px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 0 40px rgba(139, 0, 0, 0.7);
            color: #fff;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .close-btn {
            color: #ff4500;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 5px;
            right: 15px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #fff;
            text-shadow: 0 0 10px #ff4500;
        }

        .modal-title {
            color: #00ff00;
            font-size: 20px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            font-family: 'Courier New', monospace;
            word-break: break-all;
            text-align: center;
        }

        .modal-label {
            color: #999;
            font-size: 12px;
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-description {
            background: rgba(139, 0, 0, 0.1);
            border: 1px solid rgba(139, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #ccc;
            white-space: pre-wrap; /* Mantiene saltos de l√≠nea */
        }

        /* Animaciones */
        @keyframes electricGlow {
            0% { 
                background-position: 0% 50%, 0% 0%; 
                opacity: 0.4;
                filter: blur(1px);
            }
            25% { 
                background-position: 100% 50%, 50% 100%; 
                opacity: 0.9;
                filter: blur(2px);
            }
            50% { 
                background-position: 0% 50%, 100% 0%; 
                opacity: 0.6;
                filter: blur(1px);
            }
            75% { 
                background-position: 100% 50%, 0% 100%; 
                opacity: 0.8;
                filter: blur(1.5px);
            }
            100% { 
                background-position: 0% 50%, 50% 0%; 
                opacity: 0.5;
                filter: blur(1px);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Media Queries */
        @media (max-width: 360px) {
            .main-title {
                font-size: 28px;
            }
            .panel {
                padding: 15px;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            .btn {
                width: auto;
            }
        }
    </style>
<!-- Firebase App Check -->
<script>
function initializeAppCheck() {
    if (typeof firebase !== 'undefined' && firebase.appCheck) {
        const appCheck = firebase.appCheck();
        appCheck.activate('6Ld0ewksAAAAAA2GM14dH2smAWCiZpGJfWymOc4C');
        console.log('üõ°Ô∏è App Check activado');
    }
}

if (typeof firebase !== 'undefined') {
    initializeAppCheck();
} else {
    document.addEventListener('firebase-ready', initializeAppCheck);
}
</script>
</head>
<body>
    <div class="container">
        <div id="accessDenied" class="access-denied">
            <h2>‚ùå ACCESO DENEGADO</h2>
            <p>Debes iniciar sesi√≥n para acceder a los cupones.</p>
            <button class="btn" onclick="window.location.href = 'index.html'" style="margin-top: 15px; width: auto; padding: 10px 15px;">
                <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
            </button>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="header">
                <h1 class="main-title">CCSHOP</h1>
                <p class="subtitle">üéÅ SISTEMA DE CUPONES üéÅ</p>
                <div class="user-info" id="userInfo">
                    <i class="fas fa-user"></i> Cargando informaci√≥n...
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="misCupones">0</div>
                    <div class="stat-label">Mis Cupones Canjeados</div>
                </div>
            </div>

            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-ticket-alt"></i> Canjear Cup√≥n</h2>
                
                <div class="form-group">
                    <label class="form-label" for="codigoCupon">C√≥digo del Cup√≥n</label>
                    <input type="text" class="form-input" id="codigoCupon" placeholder="Ejemplo: CCSHOP-123456" maxlength="20">
                </div>
                
                <button class="btn btn-success" id="btnCanjearCupon">
                    <i class="fas fa-gift"></i> Canjear Cup√≥n
                </button>
                
                <button class="btn btn-shop" onclick="window.location.href = 'tienda.html'">
                    <i class="fas fa-shopping-cart"></i> Entrar a Tienda
                </button>
                
                <button class="btn btn-delete" id="deleteHistoryBtn" onclick="confirmarEliminarHistorial()">
                    <i class="fas fa-trash-alt"></i> Eliminar Historial
                </button>
                
                <div id="messageUser" class="message-container"></div>

                <div class="admin-link" id="adminLink" style="display: none;">
                    <a href="cupones_admin.html">
                        <i class="fas fa-user-shield"></i> Ir al Panel de Administraci√≥n
                    </a>
                </div>
            </div>

            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-history"></i> Mis Cupones Canjeados</h2>
                <div class="coupons-list" id="misCuponesList">
                    <p style="color: #999; text-align: center;">Cargando cupones...</p>
                    </div>
            </div>
        </div>
    </div>

    <div id="couponModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal()">&times;</span>
            <h3 class="modal-title" id="modalCouponCode">Cargando C√≥digo...</h3>
            <span class="coupon-status status-used" style="margin-left: auto; margin-right: auto; display: block; width: fit-content;">CANJEADO</span>

            <label class="modal-label">Mensaje / Instrucciones:</label>
            <div class="modal-description" id="modalCouponMessage">Cargando descripci√≥n...</div>
        </div>
    </div>
    <script>
        // =======================================================
        // CONFIGURACI√ìN FIREBASE
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD2tvQjJzh7ukTSyxzIQSo7GSpz7L8z11I",
            authDomain: "ccshop-realtime.firebaseapp.com",
            projectId: "ccshop-realtime",
            storageBucket: "ccshop-realtime.firebasestorage.app",
            messagingSenderId: "795626673305",
            appId: "1:795626673305:web:094dc265de1d4d1bc7d408",
            databaseURL: "https://ccshop-realtime-default-rtdb.firebaseio.com/"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUserId = null; // Variable para almacenar el ID del usuario actual

        // =======================================================
        // REPRODUCCI√ìN DE SONIDO (NUEVO)
        // =======================================================
        function reproducirSonidoExito() {
            try {
                // Aseg√∫rate de que el archivo 'check.mp3' est√© en el mismo directorio.
                const audio = new Audio('check.mp3');
                audio.play()
                    // Captura el error de reproducci√≥n, que a menudo ocurre si no hay interacci√≥n del usuario previa
                    .catch(e => console.error("Error de reproducci√≥n (puede ser por auto-play policy o path incorrecto):", e));
            } catch (error) {
                console.error('Error al intentar crear el objeto Audio:', error);
            }
        }


        // =======================================================
        // VERIFICACI√ìN DE AUTENTICACI√ìN
        // =======================================================
        function verificarAutenticacion() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('‚úÖ Usuario autenticado:', user.email);
                    currentUserId = user.uid; // Guarda el ID del usuario
                    mostrarContenidoPrincipal(user);
                    cargarDatosUsuario(user);
                    verificarSiEsAdmin(user);
                } else {
                    console.log('‚ùå Usuario no autenticado');
                    mostrarAccesoDenegado();
                }
            });
        }

        function mostrarContenidoPrincipal(user) {
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('userInfo').innerHTML = 
                `<i class="fas fa-user"></i> Conectado como: ${user.email}`;
        }

        function mostrarAccesoDenegado() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('accessDenied').style.display = 'block';
        }

        // =======================================================
        // VERIFICACI√ìN DE ADMIN
        // =======================================================
        function verificarSiEsAdmin(user) {
            // Verificar si es admin para mostrar el enlace
            database.ref('admins/' + user.uid).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        document.getElementById('adminLink').style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.log('Error verificando admin:', error);
                });
        }

        // =======================================================
        // CARGA DE DATOS DEL USUARIO
        // =======================================================
        function cargarDatosUsuario(user) {
            // El c√≥digo para cargar el saldo ha sido ELIMINADO.
            // Solo se mantiene la carga de cupones canjeados.
            
            // Cargar cupones canjeados por el usuario
            cargarMisCupones(user.uid);
        }

        // =======================================================
        // GESTI√ìN DE CUPONES - VALIDACI√ìN Y LLAMADA A FIREBASE
        // =======================================================
        function canjearCupon() {
            const codigo = document.getElementById('codigoCupon').value.trim().toUpperCase();
            
            if (!codigo) {
                mostrarMensajeUsuario('‚ùå Por favor ingresa un c√≥digo de cup√≥n', 'error');
                return;
            }

            if (!validarFormatoCupon(codigo)) {
                mostrarMensajeUsuario('‚ùå Formato de cup√≥n inv√°lido. Ejemplo: CCSHOP-123456', 'error');
                return;
            }

            console.log('Intentando verificar cup√≥n:', codigo);

            // Mostrar mensaje de "procesando" y limpiar mensajes anteriores
            mostrarMensajeUsuario('‚è≥ Verificando cup√≥n...', 'success');
            document.getElementById('btnCanjearCupon').disabled = true; // Deshabilitar bot√≥n

            // Verificar si el cup√≥n existe y est√° activo
            database.ref('cupones/' + codigo).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        mostrarMensajeUsuario('‚ùå El cup√≥n no existe', 'error');
                        return;
                    }

                    const cupon = snapshot.val();
                    
                    if (!cupon.activo) {
                        mostrarMensajeUsuario('‚ùå Este cup√≥n est√° inactivo', 'error');
                        return;
                    }

                    if (cupon.canjeado === true) { // Verificar si es estrictamente true
                        mostrarMensajeUsuario('‚ùå Este cup√≥n ya fue canjeado', 'error');
                        return;
                    }

                    // Verificar fecha de expiraci√≥n
                    if (cupon.fechaExpiracion) {
                        const ahora = new Date();
                        const expiracion = new Date(cupon.fechaExpiracion);
                        if (ahora > expiracion) {
                            mostrarMensajeUsuario('‚ùå Este cup√≥n ha expirado', 'error');
                            return;
                        }
                    }

                    // Si todo es v√°lido, proceder con el canje
                    canjearCuponEnFirebase(codigo, cupon);
                })
                .catch((error) => {
                    console.error('‚ùå Error al verificar cup√≥n:', error);
                    mostrarMensajeUsuario('‚ùå Error al verificar el cup√≥n: ' + error.message, 'error');
                })
                .finally(() => {
                    document.getElementById('btnCanjearCupon').disabled = false; // Habilitar bot√≥n
                });
        }

        /**
         * Funci√≥n corregida: Mantiene todos los campos esenciales (valor, instrucciones)
         * y agrega el email del canjeador.
         */
        function canjearCuponEnFirebase(codigo, cupon) {
            const user = auth.currentUser;
            
            console.log('üéØ INICIANDO PROCESO DE CANJE:', codigo);
            mostrarMensajeUsuario('‚è≥ Guardando registro de canje...', 'success');
            document.getElementById('btnCanjearCupon').disabled = true;

            // Crear objeto ACTUALIZADO manteniendo TODOS los campos esenciales y agregando el registro de canje
            const cuponActualizado = {
                activo: cupon.activo,
                canjeado: true, // Solo este campo cambia
                mensaje: cupon.mensaje,
                fechaCreacion: cupon.fechaCreacion,
                creadoPor: cupon.creadoPor,
                creadoPorUID: cupon.creadoPorUID,
                valor: cupon.valor || 0, // A√ëADIDO: Mantiene el valor para evitar p√©rdida
                instrucciones: cupon.instrucciones || '', // A√ëADIDO: Mantiene las instrucciones para evitar p√©rdida
                canjeadoPorEmail: user.email, // A√ëADIDO: Registra el email del usuario
                // fechaExpiracion es opcional
                ...(cupon.fechaExpiracion && { fechaExpiracion: cupon.fechaExpiracion })
            };
            
            console.log('üîÑ Actualizando cup√≥n:', cuponActualizado);
            
            // Actualizar TODO el objeto del cup√≥n (usando .set() para sobrescribir)
            database.ref('cupones/' + codigo).set(cuponActualizado) 
                .then(() => {
                    console.log('‚úÖ Cup√≥n actualizado exitosamente');
                    
                    // Registrar en historial del usuario - EN RUTA SEPARADA (con m√°s detalles)
                    const userCuponData = {
                        codigo: codigo,
                        mensaje: `üéâ ¬°Cup√≥n de $${cupon.valor || 0} USD canjeado exitosamente! üî•`,
                        instrucciones: cupon.instrucciones || '', // Guarda las instrucciones
                        valor: cupon.valor || 0, // Guarda el valor
                        fechaCanjeo: new Date().toISOString(),
                        fechaCreacion: cupon.fechaCreacion,
                        creadoPor: cupon.creadoPor
                    };

                    // Usar ruta separada para evitar problemas de permisos
                    return database.ref('historialCupones/' + user.uid + '/' + codigo).set(userCuponData);
                })
                .then(() => {
                    console.log('‚úÖ Historial del usuario actualizado');
                    
                    // LLAMADA PARA REPRODUCIR EL SONIDO DE √âXITO (NUEVO)
                    reproducirSonidoExito();

                    // Mensaje de √©xito mejorado
                    const mensajeExito = `‚úÖ ¬°Cup√≥n de $${cupon.valor || 0} USD canjeado exitosamente! üî•`;
                    
                    mostrarMensajeUsuario(mensajeExito, 'success');
                    
                    document.getElementById('codigoCupon').value = '';
                    cargarDatosUsuario(user); // Recarga los cupones canjeados
                })
                .catch((error) => {
                    console.error('‚ùå Error completo al canjear cup√≥n:', error);
                    mostrarMensajeUsuario('‚ùå Error al guardar el canje: ' + error.message, 'error');
                })
                .finally(() => {
                    document.getElementById('btnCanjearCupon').disabled = false;
                });
        }

        // =======================================================
        // CARGA DE CUPONES CANJEADOS
        // =======================================================
        /**
         * Funci√≥n corregida: Muestra el valor del cup√≥n y usa las instrucciones en el modal.
         */
        function cargarMisCupones(userId) {
            database.ref('historialCupones/' + userId).once('value')
                .then((snapshot) => {
                    const misCuponesList = document.getElementById('misCuponesList');
                    misCuponesList.innerHTML = '';
                    
                    const deleteButton = document.getElementById('deleteHistoryBtn'); // Obtener el bot√≥n

                    let contador = 0;

                    if (snapshot.exists()) {
                        const cupones = snapshot.val();
                        contador = Object.keys(cupones).length;
                        deleteButton.style.display = 'flex'; // Mostrar el bot√≥n si hay historial

                        // Ordenar por fecha de canjeo (m√°s reciente primero)
                        const cuponesOrdenados = Object.keys(cupones).sort((a, b) => {
                            return new Date(cupones[b].fechaCanjeo) - new Date(cupones[a].fechaCanjeo);
                        });


                        cuponesOrdenados.forEach(codigo => {
                            const cupon = cupones[codigo];
                            const cuponItem = document.createElement('div');
                            cuponItem.className = 'coupon-item';

                            // MODIFICACI√ìN: Usar 'instrucciones' para el modal si existe, sino 'mensaje'
                            const mensajeModal = cupon.instrucciones || cupon.mensaje || 'Cup√≥n canjeado - Sin descripci√≥n adicional.';
                            const mensajeParaClick = mensajeModal.replace(/'/g, "\\'").replace(/"/g, '\\"');
                            
                            // Agrega el evento click para mostrar el modal
                            cuponItem.setAttribute('onclick', `mostrarDetalleCupon('${codigo}', '${mensajeParaClick}')`);

                            // Formatear fechas
                            const fechaCanjeoTexto = cupon.fechaCanjeo ? new Date(cupon.fechaCanjeo).toLocaleString('es-ES') : 'N/A';
                            const fechaCreacionTexto = cupon.fechaCreacion ? new Date(cupon.fechaCreacion).toLocaleString('es-ES') : 'N/A';
                            
                            // MODIFICACI√ìN: Mostrar el valor del cup√≥n
                            const valorTexto = cupon.valor ? `$${cupon.valor} USD` : 'N/A';

                            cuponItem.innerHTML = `
                                <div class="coupon-code">${codigo}</div>
                                <div class="coupon-message">${(cupon.mensaje && cupon.mensaje.length > 50) ? cupon.mensaje.substring(0, 50) + '...' : cupon.mensaje || 'Cup√≥n canjeado'}</div>
                                <div class="coupon-details">
                                    <span><strong>Valor:</strong> ${valorTexto}</span>
                                    <span><strong>Canjeado:</strong> ${fechaCanjeoTexto}</span>
                                    <span><strong>Creado:</strong> ${fechaCreacionTexto}</span>
                                </div>
                                <div class="coupon-details">
                                    <span class="coupon-status status-used">CANJEADO</span>
                                    <span style="color: #ff4500; font-weight: bold; font-size: 11px;">(Ve a tu verfil y  canjea tu premio. )</span>
                                </div>
                            `;

                            misCuponesList.appendChild(cuponItem);
                        });
                    } else {
                        deleteButton.style.display = 'none'; // Ocultar el bot√≥n si no hay historial
                        misCuponesList.innerHTML = '<p style="color: #999; text-align: center;">A√∫n no has canjeado ning√∫n cup√≥n.</p>';
                    }

                    document.getElementById('misCupones').textContent = contador;
                })
                .catch((error) => {
                    console.error('Error cargando mis cupones:', error);
                });
        }

        function mostrarMensajeUsuario(mensaje, tipo) {
            const messageUser = document.getElementById('messageUser');
            messageUser.textContent = mensaje;
            // Reiniciar la clase para eliminar estilos de mensajes anteriores (ej: error)
            messageUser.className = 'message-container'; 
            messageUser.classList.add(tipo === 'success' ? 'message-success' : 'message-error');
            messageUser.style.display = 'block';
            
            // Eliminar la animaci√≥n de salida para mantener el mensaje
            messageUser.style.animation = 'none'; 
            
            // Scroll suave hacia el mensaje
            messageUser.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // =======================================================
        // FUNCI√ìN PARA ELIMINAR HISTORIAL (NUEVO)
        // =======================================================
        function confirmarEliminarHistorial() {
            if (!currentUserId) {
                alert('No se pudo determinar el usuario para eliminar el historial.');
                return;
            }

            const confirmacion = confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar TODO tu historial de cupones canjeados? Esta acci√≥n es irreversible.');

            if (confirmacion) {
                eliminarHistorial(currentUserId);
            }
        }

        function eliminarHistorial(userId) {
            console.log('üóëÔ∏è Iniciando eliminaci√≥n del historial para:', userId);
            mostrarMensajeUsuario('‚è≥ Eliminando historial...', 'error');
            
            // Referencia al historial del usuario
            const historialRef = database.ref('historialCupones/' + userId);
            
            historialRef.remove()
                .then(() => {
                    console.log('‚úÖ Historial de cupones eliminado exitosamente.');
                    mostrarMensajeUsuario('‚úÖ Tu historial de cupones ha sido eliminado.', 'success');
                    
                    // Recarga los datos y cupones para actualizar la vista
                    cargarDatosUsuario(auth.currentUser);
                })
                .catch((error) => {
                    console.error('‚ùå Error al eliminar el historial:', error);
                    mostrarMensajeUsuario('‚ùå Error al eliminar el historial. Por favor, int√©ntalo de nuevo.', 'error');
                })
                .finally(() => {
                    document.getElementById('deleteHistoryBtn').style.display = 'none';
                });
        }


        // =======================================================
        // GESTI√ìN DEL MODAL
        // =======================================================
        function mostrarDetalleCupon(codigo, mensaje) {
            const modal = document.getElementById('couponModal');
            document.getElementById('modalCouponCode').textContent = codigo;
            document.getElementById('modalCouponMessage').textContent = mensaje;
            modal.style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('couponModal').style.display = 'none';
        }

        // Cerrar el modal al hacer clic fuera de su contenido
        window.onclick = function(event) {
            const modal = document.getElementById('couponModal');
            if (event.target == modal) {
                cerrarModal();
            }
        }

        // =======================================================
        // CONFIGURACI√ìN DE EVENT LISTENERS
        // =======================================================
        function configurarEventListeners() {
            // Bot√≥n canjear cup√≥n
            const btnCanjearCupon = document.getElementById('btnCanjearCupon');
            if (btnCanjearCupon) {
                btnCanjearCupon.addEventListener('click', canjearCupon);
            }

            // Enter en el input
            const inputCodigo = document.getElementById('codigoCupon');
            if (inputCodigo) {
                inputCodigo.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        canjearCupon();
                    }
                });
            }
        }

        // =======================================================
        // INICIALIZACI√ìN
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéÅ Iniciando Sistema de Cupones Frontend');
            verificarAutenticacion();
            configurarEventListeners();
        });
        
        function validarFormatoCupon(codigo) {
            // Permitir diferentes formatos
            const regex = /^CCSHOP-?[A-Z0-9]{6,10}$/i;
            const esValido = regex.test(codigo);
            console.log(`üîç Validando formato "${codigo}": ${esValido ? 'V√ÅLIDO' : 'INV√ÅLIDO'}`);
            return esValido;
        }
    </script>
</body>
</html>
