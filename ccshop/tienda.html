<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCshop - Dashboard Premium</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            min-height: 100vh; 
            color: white; 
            overflow-x: hidden;
            position: relative;
        }

        /* Efecto de part√≠culas animadas en el fondo - MEJORADO */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 0, 0, 0.2) 0%, rgba(255, 0, 0, 0.05) 70%);
            border-radius: 50%;
            animation: float 8s infinite ease-in-out;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.1);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); opacity: 0.6; }
            50% { transform: translateY(-30px) rotate(180deg) scale(1.1); opacity: 0.3; }
        }

        /* HEADER PROFESIONAL MEJORADO - M√ÅS ELEGANTE */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 25px; 
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 0, 0, 0.4);
            height: 70px; 
            position: sticky; 
            top: 0; 
            z-index: 999;
            box-shadow: 0 4px 40px rgba(255, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            font-size: 28px;
            background: linear-gradient(135deg, #ff0000, #cc0000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 12px rgba(255, 0, 0, 0.6));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .brand-text {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #ff0000, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        /* BOT√ìN DE PERFIL MEJORADO - M√ÅS SOPHISTICADO */
        .profile-btn { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: white; 
            cursor: pointer; 
            padding: 0;
            font-size: 14px; 
            border-radius: 14px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            width: 50px;
            height: 50px;
        }

        .profile-btn i {
            font-size: 20px;
            transition: transform 0.3s ease;
            display: block;
            margin: 0 auto;
            padding: 0;
        }

        .profile-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.6s;
        }

        .profile-btn:hover { 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.1));
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.4), 0 0 0 1px rgba(255, 0, 0, 0.5);
            border-color: rgba(255, 0, 0, 0.7);
        }

        .profile-btn:hover i {
            transform: scale(1.1);
        }

        .profile-btn:hover::before {
            left: 100%;
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            padding: 12px 20px;
            border-radius: 14px;
            border: 1px solid rgba(255, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .balance-label {
            font-size: 14px;
            color: #aaa;
            font-weight: 600;
        }

        .balance { 
            color: #ff0000; 
            font-size: 20px; 
            font-weight: bold; 
            font-family: 'Courier New', monospace; 
            text-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
        }

        .time-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
            padding: 6px 8px;
            border-radius: 14px;
            border: 1px solid rgba(255, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 140px;
            word-wrap: break-word;
            overflow: hidden;
        }

        .time-label {
            font-size: 9px;
            color: #aaa;
            font-weight: 600;
            text-align: left;
            margin-left: 0;
            padding-left: 0;
            line-height: 1.1;
        }

        .time { 
            color: #ff0000; 
            font-size: 12px; 
            font-weight: bold; 
            font-family: 'Courier New', monospace; 
            text-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
            text-align: left;
            margin-left: 0;
            padding-left: 0;
        }

        .header-buttons { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        /* BOTONES DE √çCONOS MEJORADOS - M√ÅS ELEGANTE */
        .icon-btn { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white; 
            cursor: pointer; 
            padding: 14px;
            font-size: 16px; 
            position: relative; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 14px;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            backdrop-filter: blur(10px);
            text-decoration: none; /* A√±adido para el nuevo <a> */
        }

        .icon-btn i {
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        
        /* Nuevo Estilo para el bot√≥n de gr√°fica (si quieres destacarlo) */
        .btn-grafica {
            background: linear-gradient(135deg, rgba(30, 200, 30, 0.2), rgba(30, 200, 30, 0.1));
            border: 1px solid rgba(0, 255, 0, 0.5);
        }

        .btn-grafica:hover {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.3), rgba(0, 255, 0, 0.15));
            box-shadow: 0 10px 30px rgba(0, 255, 0, 0.4), 0 0 0 1px rgba(0, 255, 0, 0.5);
            border-color: rgba(0, 255, 0, 0.7);
        }

        .icon-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.6s;
        }

        .icon-btn:hover { 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.1));
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.4), 0 0 0 1px rgba(255, 0, 0, 0.5);
            border-color: rgba(255, 0, 0, 0.5);
        }

        .icon-btn:hover i {
            transform: scale(1.1);
        }

        .icon-btn:hover::before {
            left: 100%;
        }

        .notification-badge { 
            position: absolute; 
            top: 2px; 
            right: 2px; 
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: white; 
            border-radius: 50%; 
            width: 18px; 
            height: 18px; 
            font-size: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(255, 0, 0, 0.5);
        }

        .menu-btn .notification-badge {
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            font-size: 9px;
        }

        .menu-item .notification-badge {
            position: static;
            margin-left: auto;
            width: 20px;
            height: 20px;
            font-size: 12px;
        }
        
        /* BOT√ìN DE MEN√ö MEJORADO - M√ÅS SOPHISTICADO */
        .menu-btn { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white; 
            cursor: pointer; 
            padding: 14px;
            display: flex; 
            flex-direction: column; 
            gap: 3px; 
            border-radius: 14px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            backdrop-filter: blur(10px);
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.6s;
        }

        .menu-btn:hover { 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.1));
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.4), 0 0 0 1px rgba(255, 0, 0, 0.5);
            border-color: rgba(255, 0, 0, 0.5);
        }

        .menu-btn:hover::before {
            left: 100%;
        }

        .menu-line { 
            width: 22px; 
            height: 2px; 
            background: white; 
            transition: all 0.4s ease; 
            border-radius: 2px;
            transform-origin: center;
        }

        .menu-btn:hover .menu-line { 
            background: #ff0000; 
            width: 24px;
        }
        
        /* MEN√öS CONTEXTUALES MEJORADOS - M√ÅS REFINADOS */
        .context-menu { 
            position: fixed; 
            top: 75px; 
            background: rgba(26, 26, 26, 0.98);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 0, 0, 0.4);
            border-radius: 16px; 
            padding: 0;
            display: none; 
            z-index: 1000; 
            min-width: 280px; 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(255, 0, 0, 0.2);
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .menu-profile { left: 20px; }
        .menu-messages { right: 20px; max-height: 450px; overflow-y: auto; width: 90vw; max-width: 420px; }
        .menu-main { right: 20px; }
        
        /* √çTEMS DE MEN√ö MEJORADOS - M√ÅS PREMIUM */
        .menu-item { 
            padding: 14px 18px; 
            font-size: 14px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(42, 42, 42, 0.6); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            margin: 4px 8px;
            background: rgba(255, 255, 255, 0.03);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }

        .menu-item i {
            width: 18px;
            text-align: center;
            font-size: 15px;
            transition: transform 0.3s ease;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 0, 0, 0.15), transparent);
            transition: left 0.6s;
        }

        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.1)); 
            transform: translateX(8px) scale(1.02);
            border-left: 4px solid #ff0000;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.3);
            margin-left: 6px;
            margin-right: 10px;
        }

        .menu-item:hover i {
            transform: scale(1.1);
        }

        .menu-item:hover::before {
            left: 100%;
        }
        
        /* PERFIL MEJORADO - M√ÅS ELEGANTE */
        .profile-info { 
            padding: 20px; 
            border-bottom: 1px solid rgba(51, 51, 51, 0.6); 
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9), rgba(42, 42, 42, 0.9)); 
            border-radius: 12px 12px 0 0; 
            margin: 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .profile-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff0000, #cc0000);
        }

        .profile-name { 
            font-weight: bold; 
            color: #ff0000; 
            font-size: 16px; 
            margin-bottom: 6px;
        }

        .profile-email { 
            display: block; 
            font-size: 13px; 
            color: #bbb; 
            margin-bottom: 10px;
        }

        .profile-balance { 
            font-size: 14px; 
            color: #ff0000; 
            font-family: 'Courier New', monospace; 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.15), rgba(255, 0, 0, 0.1));
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid rgba(255, 0, 0, 0.3);
            box-shadow: 0 2px 10px rgba(255, 0, 0, 0.2);
        }
        
        /* MENSAJES DE COMPRAS - MEJORADO */
        .message-item { 
            padding: 18px; 
            font-size: 13px; 
            border-bottom: 1px solid rgba(42, 42, 42, 0.6); 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px; 
            margin: 8px; 
            background: linear-gradient(135deg, rgba(42, 26, 26, 0.8), rgba(29, 13, 13, 0.8)); 
            border-left: 5px solid #ff0000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .message-item:hover { 
            background: linear-gradient(135deg, rgba(58, 42, 42, 0.9), rgba(42, 26, 26, 0.9)); 
            transform: translateX(8px); 
            box-shadow: 0 10px 25px rgba(255, 0, 0, 0.3);
        }

        .message-sender { 
            font-weight: bold; 
            color: #ff0000; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .message-preview { color: #ddd; font-size: 12px; margin-top: 5px; line-height: 1.5; }
        .message-time { font-size: 11px; color: #999; margin-top: 8px; font-style: italic; }
        .empty-messages { padding: 40px 25px; text-align: center; color: #777; font-style: italic; font-size: 13px; }
        
        /* ACCIONES DEL MEN√ö DE MENSAJES - MEJORADAS */
        .messages-header { 
            padding: 16px 18px; 
            background: linear-gradient(135deg, rgba(61, 26, 26, 0.9), rgba(42, 13, 13, 0.9)); 
            border-radius: 12px 12px 0 0; 
            margin: 0;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative;
            overflow: hidden;
        }

        .messages-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff0000, #cc0000);
        }

        .messages-title { 
            color: #ff0000; 
            font-weight: bold; 
            font-size: 15px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .messages-title i {
            font-size: 18px;
        }

        .messages-actions { display: flex; gap: 10px; }
        .action-btn-small { 
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.9), rgba(42, 42, 42, 0.7)); 
            border: 1px solid rgba(68, 68, 68, 0.6); 
            color: white; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .action-btn-small:hover { 
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.4), rgba(255, 0, 0, 0.2)); 
            transform: scale(1.08); 
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }
        
        /* MODAL PROFESIONAL MEJORADO - M√ÅS REFINADO */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.95); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(15px); 
            animation: fadeIn 0.4s ease; 
            padding: 20px;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-container { 
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98), rgba(42, 42, 42, 0.98)); 
            border-radius: 20px; 
            width: 100%;
            max-width: 550px; 
            max-height: 90vh; 
            overflow-y: auto; 
            border: 2px solid #ff0000; 
            box-shadow: 0 25px 70px rgba(255, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1); 
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .modal-header { 
            background: linear-gradient(135deg, #a80000, #800000); 
            padding: 18px 25px; 
            border-radius: 18px 18px 0 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(168, 0, 0, 0.3);
        }

        .modal-title { 
            font-size: 18px; 
            font-weight: bold; 
            color: white; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .modal-title i {
            font-size: 20px;
        }

        .modal-close { 
            background: rgba(255, 255, 255, 0.15); 
            border: none; 
            color: white; 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            font-size: 18px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .modal-close:hover { 
            background: #ff0000; 
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }
        
        .modal-body { 
            padding: 25px; 
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .info-section { 
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9), rgba(42, 42, 42, 0.9)); 
            border-radius: 14px; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-left: 5px solid #ff0000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .info-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff0000, #cc0000);
        }

        .section-title { 
            color: #ff0000; 
            font-size: 15px; 
            font-weight: bold; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-bottom: 1px solid rgba(51, 51, 51, 0.6); 
            padding-bottom: 10px; 
        }

        .section-title i {
            font-size: 18px;
        }
        
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px solid rgba(42, 42, 42, 0.6); 
            font-size: 14px; 
        }

        .info-row:last-child { border-bottom: none; }
        .info-label { color: #aaa; display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .info-label i {
            font-size: 13px;
            color: #ff0000;
        }
        .info-value { color: white; font-weight: bold; font-family: 'Courier New', monospace; }
        .info-value.highlight { color: #ff0000; text-shadow: 0 0 5px rgba(255, 0, 0, 0.5); }
        
        .modal-actions { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            padding: 20px; 
            background: linear-gradient(135deg, rgba(13, 13, 13, 0.95), rgba(26, 26, 26, 0.95)); 
            border-radius: 0 0 18px 18px; 
            position: sticky;
            bottom: 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        }
        
        .action-btn { 
            padding: 14px; 
            border: none; 
            border-radius: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            font-size: 14px; 
            position: relative;
            overflow: hidden;
        }

        .action-btn i {
            font-size: 15px;
            transition: transform 0.3s ease;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .btn-copy { 
            background: linear-gradient(135deg, #7a1a1a, #6a0d0d); 
            color: white; 
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .btn-copy:hover { 
            background: linear-gradient(135deg, #9a2a2a, #8a1a1a); 
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(122, 26, 26, 0.4);
        }

        .btn-copy:hover i {
            transform: scale(1.1);
        }

        .btn-export { 
            background: linear-gradient(135deg, #5f1a7a, #4d0d6a); 
            color: white; 
            border: 1px solid rgba(95, 26, 122, 0.3);
        }

        .btn-export:hover { 
            background: linear-gradient(135deg, #7f2a9a, #6d1a8a); 
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(95, 26, 122, 0.4);
        }

        .btn-close { 
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.9), rgba(58, 58, 58, 0.9)); 
            color: white; 
            grid-column: 1 / -1; 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-close:hover { 
            background: linear-gradient(135deg, rgba(58, 58, 58, 1), rgba(42, 42, 42, 1)); 
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        .action-btn:hover::before {
            left: 100%;
        }
        
        /* SCROLLBAR PERSONALIZADO - MEJORADO */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(26, 26, 26, 0.9); border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ff0000, #cc0000); border-radius: 5px; border: 1px solid rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #cc0000, #990000); }
        
        /* TOAST NOTIFICATIONS MEJORADAS - M√ÅS ELEGANTE */
        .toast { 
            position: fixed; 
            bottom: 25px; 
            right: 25px; 
            background: linear-gradient(135deg, #008000, #006400);
            color: white; 
            padding: 18px 25px; 
            border-radius: 12px; 
            box-shadow: 0 12px 40px rgba(0, 128, 0, 0.6);
            z-index: 3000; 
            display: none; 
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 5px solid #00ff00;
            max-width: 350px;
            font-weight: 500;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        
        .toast.error { 
            background: linear-gradient(135deg, #a80000, #800000); 
            border-left: 5px solid #ff0000;
            box-shadow: 0 12px 40px rgba(168, 0, 0, 0.6);
        }

        /* MEDIA QUERIES PARA RESPONSIVE */
        @media (max-width: 768px) {
            .header { padding: 12px 20px; height: 65px; }
            .header-left { gap: 15px; }
            .brand-text { font-size: 22px; }
            .balance { font-size: 18px; }
            .icon-btn { width: 45px; height: 45px; font-size: 16px; padding: 12px; }
            .profile-btn { width: 45px; height: 45px; }
            .profile-btn i { font-size: 18px; }
            .menu-btn { padding: 12px; }
            
            .menu-messages { width: 95vw; max-width: none; right: 2.5vw; }
            
            .modal-container { width: 95%; border-radius: 15px; }
            
            .modal-actions { grid-template-columns: 1fr; gap: 10px; }
        }
        
        @media (max-width: 480px) {
            .header { flex-direction: column; height: auto; padding: 15px; gap: 15px; }
            .header-left { width: 100%; justify-content: space-between; }
            .header-buttons { width: 100%; justify-content: space-between; }
            .balance-container { width: 100%; justify-content: center; }
            
            .menu-profile { left: 10px; }
            
            .message-item { padding: 15px; margin: 6px; }
        }

        /* === FEED USUARIOS ACTIVOS - MISMO ESTILO TIENDA === */
        .floating-feed {
            position: fixed;
            top: 205px;
            left: 0px;
            right:0px;
            width: auto;
            height: 500px;
            background: rgba(15, 15, 15, 0.98);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 0, 0, 0.4);
            border-radius: 0px;
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.3);
            z-index: 100;
            overflow: hidden;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .feed-header {
            background: linear-gradient(135deg, rgba(168, 0, 0, 0.9), rgba(128, 0, 0, 0.9));
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 0, 0, 0.4);
        }

        .feed-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-indicator {
            margin-left: auto;
            background: rgba(255, 0, 0, 0.9);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .usuarios-activos-container {
            padding: 15px;
        }

        .usuarios-stats {
            background: rgba(255, 0, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ff0000;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .usuarios-icon {
            font-size: 24px;
        }

        .usuarios-info {
            flex: 1;
        }

        .usuarios-number {
            font-size: 24px;
            font-weight: bold;
            color: #ff4444;
            font-family: 'Courier New', monospace;
        }

        .usuarios-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }

        .activity-list {
            overflow-y: auto;
            height: 300px;
        }

        .activity-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #ff0000;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(255, 0, 0, 0.1);
            transform: translateX(5px);
        }

        .activity-user {
            color: #ff4444;
            font-weight: bold;
            margin-bottom: 3px;
            font-family: 'Courier New', monospace;
        }

        .activity-details {
            color: #ddd;
            line-height: 1.3;
        }

        .activity-product {
            color: #00ff00;
            font-weight: 600;
        }

        .activity-time {
            color: #888;
            font-size: 10px;
            margin-top: 2px;
        }

        .activity-amount {
            color: #00ff00;
            font-weight: bold;
            float: right;
        }
    </style>
</head>
<body>

    <div id="securityLoading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a0a;display:flex;justify-content:center;align-items:center;z-index:9999;">
        <div style="text-align:center;">
            <div style="font-size:2rem;margin-bottom:20px;">üîí</div>
            <div>Verificando seguridad...</div>
        </div>
    </div>

    <div class="particles" id="particles"></div>

    <div class="header">
        <div class="header-left">
            <div class="brand">
                <div class="brand-icon"><i class="fas fa-credit-card"></i></div>
                <div class="brand-text">CCSHOP</div>
            </div>
            <button class="profile-btn" onclick="toggleMenu('profile')" title="Mi Perfil">
                <i class="fas fa-user"></i>
            </button>
            <div class="time-container">
                <div class="time-label">HORA Y FECHA DEL SERVIDOR</div>
                <div class="time" id="serverTime">Cargando...</div>
            </div>
        </div>
        
        <div class="balance-container">
            <div class="balance-label">Saldo:</div>
            <div class="balance" id="saldoUsuario">Cargando...</div>
        </div>
        
        <div class="header-buttons">
            <a href="grafica.html" class="icon-btn btn-grafica" title="Ver Gr√°fica de Actividad">
                <i class="fas fa-chart-line"></i>
            </a>
            <button class="icon-btn" onclick="openStore()" title="Tienda Completa"><i class="fas fa-store"></i></button>
            <button class="icon-btn" onclick="toggleMenu('messages')" title="Mensajes">
                <i class="fas fa-envelope"></i><div id="messageBadge" class="notification-badge" style="display: none;">0</div>
            </button>
            <button class="menu-btn" id="menuBtn" onclick="toggleMenu('main')" title="Men√∫">
                <div id="mainMenuBadge" class="notification-badge" style="display: none;">!</div>
                <div class="menu-line"></div>
                <div class="menu-line"></div>
                <div class="menu-line"></div>
            </button>
        </div>
    </div>

    <div class="context-menu menu-profile" id="profileMenu">
        <div class="profile-info">
            <div class="profile-name">Usuario Premium</div>
            <div class="profile-email" id="profileEmail">usuario@ccshop.com</div>
            <div class="profile-balance">Saldo: $0.00</div>
        </div>
        <div class="menu-item" onclick="irAPerfil()"><i class="fas fa-user"></i> Mi Perfil</div>
        <div class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</div>
    </div>

    <div class="context-menu menu-messages" id="messagesMenu">
        <div class="messages-header">
            <div class="messages-title"><i class="fas fa-envelope"></i> Compras Recientes</div>
            <div class="messages-actions">
                <button class="action-btn-small" onclick="exportarTodasCompras()" title="Exportar todas"><i class="fas fa-download"></i> Exportar</button>
            </div>
        </div>
        <div id="comprasList" class="compras-list">
            <div class="empty-messages">Cargando compras recientes...</div>
        </div>
    </div>

    <div class="context-menu menu-main" id="mainMenu">
        <div class="menu-item" onclick="window.location.href='pagos/wallet-usdt.html'" style="background: rgba(26, 61, 26, 0.8); border-left: 4px solid #00ff00;">
            <i class="fas fa-money-bill-wave"></i> Recargar Saldo
        </div>
        <div class="menu-item" onclick="window.location.href='reglas.html'" style="background: rgba(61, 61, 26, 0.8); border-left: 4px solid #ffff00;">
            <i class="fas fa-clipboard-list"></i> Reglas
        </div>
        <div class="menu-item" onclick="window.location.href='historial.html'" style="background: rgba(61, 26, 26, 0.8); border-left: 4px solid #ff0000;">
            <i class="fas fa-chart-bar"></i> Historial
        </div>
        <div class="menu-item" id="supportMenuItem" onclick="acknowledgeNotifications();" style="background: rgba(26, 61, 61, 0.8); border-left: 4px solid #00ffff;">
            <i class="fas fa-shield-alt"></i> Soporte 24/7
            <span id="supportBadge" class="notification-badge" style="display: none;">!</span>
        </div>
        <div class="menu-item" id="adminMenuItem" onclick="if(esUsuarioAdmin(usuarioActual)) location.href='admin.html';" style="display: none; background: rgba(61, 26, 61, 0.8); border-left: 4px solid #ff00ff;">
            <i class="fas fa-cogs"></i> Panel Admin
        </div>
    </div>

    <div class="modal-overlay" id="modalDetalleCompra">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    <span>Detalle de Compra</span>
                </div>
                <button class="modal-close" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="modal-body" id="modalContent">
                </div>
            
            <div class="modal-actions">
                <button class="action-btn btn-copy" onclick="copiarDatosCompra()">
                    <i class="fas fa-copy"></i> Copiar
                </button>
                <button class="action-btn btn-export" onclick="exportarCompra()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="action-btn btn-close" onclick="cerrarModal()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
    // ========================================
    // CONFIGURACI√ìN FIREBASE
    // ========================================
    const firebaseConfig = {
        apiKey: "AIzaSyD2tvQjJzh7ukTSyxzIQSo7GSpz7L8z11I",
        authDomain: "ccshop-realtime.firebaseapp.com",
        databaseURL: "https://ccshop-realtime-default-rtdb.firebaseio.com",
        projectId: "ccshop-realtime",
        storageBucket: "ccshop-realtime.firebasestorage.app",
        messagingSenderId: "795626673305",
        appId: "1:795626673305:web:094dc265de1d4d1bc7d408"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rtdb = firebase.database();
    const auth = firebase.auth();

    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let saldoActual = 0.00;
    let usuarioActual = null;
    let activeMenu = null;
    let comprasUnread = 0;
    let compraActual = null;
    let ticketsListener = null;
    let comprasListener = null;
    let feedListener = null;
    let sistemaInicializado = false;

    // ========================================
    // üõ°Ô∏è VERIFICACI√ìN DE SEGURIDAD - MEJORADA
    // ========================================
    function verificarAccesoSeguro() {
        console.log('üîê Verificando acceso seguro...');
        
        const hasSessionAuth = sessionStorage.getItem('auth_verified') === 'true';
        const hasLocalCaptcha = localStorage.getItem('passedCaptcha') === 'true';
        
        console.log('Session Auth:', hasSessionAuth);
        console.log('Local Captcha:', hasLocalCaptcha);
        
        if (hasSessionAuth || hasLocalCaptcha) {
            console.log('‚úÖ Acceso seguro verificado');
            sessionStorage.setItem('auth_verified', 'true');
            return true;
        }
        
        console.warn('üö´ Acceso no autorizado - Redirigiendo a verificaci√≥n');
        sessionStorage.removeItem('auth_verified');
        localStorage.removeItem('passedCaptcha');
        
        // Redirecci√≥n con timeout para evitar loops
        setTimeout(() => {
            window.location.href = 'verificacion.html';
        }, 1000);
        return false;
    }

    // ========================================
    // üîí PROTECCI√ìN CONTRA INSPECCI√ìN
    // ========================================
    document.addEventListener('contextmenu', (e) => e.preventDefault());
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
            (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
            return false;
        }
    });

    // ========================================
    // FUNCI√ìN PARA VERIFICAR SI ES ADMIN
    // ========================================
    function esUsuarioAdmin(user) {
        return user && user.email && user.email.toLowerCase().trim() === 'johndoechmod777@gmail.com';
    }

    // ========================================
    // SISTEMA DE PART√çCULAS ANIMADAS
    // ========================================
    function crearParticulas() {
        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer) return;

        const particleCount = 15;
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            const size = Math.random() * 100 + 50;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.opacity = Math.random() * 0.1 + 0.02;
            particle.style.animationDelay = `${Math.random() * 8}s`;
            particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
            
            particlesContainer.appendChild(particle);
        }
    }

    // ========================================
    // SISTEMA DE NOTIFICACIONES DE TICKETS
    // ========================================
    function cargarNotificacionesTickets(email) {
        console.log('üîç Buscando tickets para: ' + email);

        if (ticketsListener) {
            ticketsListener();
            ticketsListener = null;
        }

        const ticketsQuery = db.collection('tickets')
            .where('usuario_email', '==', email)
            .orderBy('fecha_creacion', 'desc');

        ticketsListener = ticketsQuery.onSnapshot((snapshot) => {
            console.log('Tickets encontrados: ' + snapshot.size);

            let tieneNotificacion = false;
            let ticketsConNotif = [];
            
            snapshot.forEach((doc) => {
                const ticketData = doc.data();
                const ticketId = doc.id;
                const estado = ticketData.estado || 'abierto';
                
                let notificacionTicket = false;
                const ultimaVezVisto = localStorage.getItem(`ticket_visto_${ticketId}`) || '1970-01-01T00:00:00.000Z';

                if (ticketData.mensajes && Array.isArray(ticketData.mensajes)) {
                    const ultimoMensajeAdmin = ticketData.mensajes.findLast(msg => msg.tipo === 'admin');
                    
                    if (ultimoMensajeAdmin && ultimoMensajeAdmin.fecha?.toDate) {
                        const fechaUltimoAdmin = ultimoMensimoAdmin.fecha.toDate();
                        if (fechaUltimoAdmin > new Date(ultimaVezVezVisto)) {
                            notificacionTicket = true;
                        }
                    }
                }
                
                const fechaActualizacion = ticketData.fecha_actualizacion?.toDate ? ticketData.fecha_actualizacion.toDate() : ticketData.fecha_creacion?.toDate ? ticketData.fecha_creacion.toDate() : new Date(0);
                
                if ((estado === 'pendiente' || estado === 'cerrado') && fechaActualizacion > new Date(ultimaVezVisto)) {
                    notificacionTicket = true;
                }

                if (notificacionTicket) {
                    tieneNotificacion = true;
                    ticketsConNotif.push({id: ticketId});
                }
            });

            const supportBadge = document.getElementById('supportBadge');
            const mainMenuBadge = document.getElementById('mainMenuBadge');
            
            if (tieneNotificacion) {
                const count = ticketsConNotif.length;
                const displayText = count > 9 ? '+9' : count.toString();

                if (supportBadge) {
                    supportBadge.textContent = displayText;
                    supportBadge.style.display = 'flex';
                }
                if (mainMenuBadge) {
                    mainMenuBadge.textContent = displayText;
                    mainMenuBadge.style.display = 'flex';
                }
            } else {
                if (supportBadge) supportBadge.style.display = 'none';
                if (mainMenuBadge) mainMenuBadge.style.display = 'none';
            }
        }, (error) => {
            console.error('‚ùå Error al cargar tickets:', error.message);
        });
    }

    function acknowledgeNotifications() {
        const supportBadge = document.getElementById('supportBadge');
        const mainMenuBadge = document.getElementById('mainMenuBadge');
        if (supportBadge) supportBadge.style.display = 'none';
        if (mainMenuBadge) mainMenuBadge.style.display = 'none';
        window.location.href = 'soporte.html';
    }

    // ========================================
    // SISTEMA DE COMPRAS - VERSI√ìN MEJORADA
    // ========================================
    function cargarComprasComoMensajes() {
        const user = auth.currentUser;
        if (!user) {
            document.getElementById('comprasList').innerHTML = '<div class="empty-messages">Inicia sesi√≥n para ver tus compras</div>';
            return;
        }

        // Limpiar listener anterior si existe
        if (comprasListener) {
            comprasListener();
        }

        const userEmail = user.email.toLowerCase().trim();

        comprasListener = db.collection('compras')
            .where('usuario_email', '==', userEmail)
            .orderBy('fecha_compra', 'desc')
            .onSnapshot(snapshot => {
                if (!snapshot.empty) {
                    mostrarComprasEnMenu(snapshot);
                } else {
                    document.getElementById('comprasList').innerHTML = `
                        <div class="empty-messages">
                            No se encontraron compras recientes
                        </div>
                    `;
                    actualizarBadgeMensajes();
                }
            }, error => {
                console.error('‚ùå Error en listener de compras:', error);
                document.getElementById('comprasList').innerHTML = '<div class="empty-messages">Error al cargar compras</div>';
                actualizarBadgeMensajes();
            });
    }

    function mostrarComprasEnMenu(snapshot) {
        const comprasArray = [];
        snapshot.forEach(doc => {
            comprasArray.push({ id: doc.id, data: doc.data() });
        });

        let comprasHTML = '';
        comprasUnread = 0;

        comprasArray.forEach(({ id, data: compra }) => {
            const esDump = compra.tipo_tarjeta && (compra.tipo_tarjeta.includes('Visa') || compra.tipo_tarjeta.includes('Mastercard'));
            
            let numeroParcial, nombreCompleto, tipoProducto;
            
            const numeroCC = compra.numero_tarjeta || compra.numero; 
            
            if (esDump) {
                numeroParcial = formatearNumeroTarjeta(numeroCC);
                nombreCompleto = compra.nombre_titular || 'Titular no disponible';
                tipoProducto = compra.tipo_tarjeta || 'Dump Premium';
            } else {
                numeroParcial = formatearNumeroTarjeta(numeroCC);
                nombreCompleto = compra.titular || compra.nombre_titular || 'Titular no disponible';
                tipoProducto = compra.marca || 'Tarjeta Premium';
            }
            
            const fecha = compra.fecha_compra?.toDate ? compra.fecha_compra.toDate() : new Date(0);
            const fechaFormateada = formatearTiempoRelativo(fecha);
            
            const leido = compra.leido === undefined ? false : compra.leido;
            if (!leido) comprasUnread++;

            const itemStyle = leido ? '' : 'style="background: linear-gradient(135deg, rgba(68, 20, 20, 0.8), rgba(42, 13, 13, 0.8)); border-left: 5px solid #ff4500;"';

            comprasHTML += `
                <div class="message-item" ${itemStyle} onclick="verDetalleCompra('${id}')">
                    <div class="message-sender">
                        <i class="fas fa-check-circle" style="color: #00ff00;"></i>
                        <span>CCSHOP - Compra Exitosa</span>
                    </div>
                    <div class="message-preview">
                        <strong><i class="fas fa-credit-card"></i> Producto:</strong> ${tipoProducto} ${numeroParcial}
                    </div>
                    <div class="message-preview">
                        <strong><i class="fas fa-user"></i> Titular:</strong> ${nombreCompleto}
                    </div>
                    <div class="message-preview">
                        <strong><i class="fas fa-dollar-sign"></i> Precio:</strong> $${(compra.precio || 0.00).toFixed(2)} USDT
                    </div>
                    <div class="message-time"><i class="fas fa-clock"></i> ${fechaFormateada}</div>
                </div>
            `;
        });

        document.getElementById('comprasList').innerHTML = comprasHTML;
        actualizarBadgeMensajes();
    }

    function verDetalleCompra(compraId) {
        db.collection('compras').doc(compraId).update({ leido: true })
            .catch(error => console.error('Error al marcar como le√≠do:', error));

        db.collection('compras').doc(compraId).get()
            .then(doc => {
                if (doc.exists) {
                    compraActual = { id: doc.id, data: doc.data() };
                    mostrarModalDetalle();
                } else {
                    mostrarToast('‚ö†Ô∏è Compra no encontrada', true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarToast('‚ùå Error al cargar detalles', true);
            });
    }

    function mostrarModalDetalle() {
        if (!compraActual) return;
        
        const compra = compraActual.data;
        
        const esDump = compra.tipo_tarjeta && (compra.tipo_tarjeta.includes('Visa') || compra.tipo_tarjeta.includes('Mastercard'));
        
        const numeroCompleto = compra.numero_tarjeta || compra.numero || 'N/A';
        const cvvCompleto = compra.cvv || 'N/A';
        const titular = compra.titular || compra.nombre_titular || 'N/A';
        const vencimiento = compra.fecha_expiracion || compra.fecha_vencimiento || compra.vencimiento || 'N/A';
        const marca = compra.tipo_tarjeta || compra.marca || 'N/A';
        const banco = compra.banco || 'N/A';
        const precio = (compra.precio || 0.00).toFixed(2);
        const pais = compra.pais || 'N/A';
        const bin = compra.bin || (numeroCompleto !== 'N/A' && numeroCompleto.length >= 6 ? numeroCompleto.substring(0, 6) : 'N/A');
        
        let fechaTexto = 'N/A';
        if (compra.fecha_compra?.toDate) {
            fechaTexto = compra.fecha_compra.toDate().toLocaleString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        const contenidoHTML = `
            <div class="info-section">
                <div class="section-title"><i class="fas fa-credit-card"></i> Informaci√≥n de la Tarjeta</div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-hashtag"></i> N√∫mero</span>
                    <span class="info-value highlight">${numeroCompleto}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-gem"></i> Marca</span>
                    <span class="info-value">${marca}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-key"></i> CVV</span>
                    <span class="info-value highlight">${cvvCompleto}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-calendar-alt"></i> Vencimiento</span>
                    <span class="info-value">${vencimiento}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-university"></i> Banco</span>
                    <span class="info-value">${banco}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-barcode"></i> BIN</span>
                    <span class="info-value">${bin}</span>
                </div>
            </div>

            <div class="info-section">
                <div class="section-title"><i class="fas fa-user"></i> Titular</div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-id-badge"></i> Nombre</span>
                    <span class="info-value">${titular}</span>
                </div>
            </div>

            <div class="info-section">
                <div class="section-title"><i class="fas fa-dollar-sign"></i> Transacci√≥n</div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-money-bill-wave"></i> Precio</span>
                    <span class="info-value highlight">$${precio} USDT</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-globe"></i> Pa√≠s</span>
                    <span class="info-value">${pais}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-clock"></i> Fecha</span>
                    <span class="info-value">${fechaTexto}</span>
                </div>
            </div>
        `;

        document.getElementById('modalContent').innerHTML = contenidoHTML;
        document.getElementById('modalDetalleCompra').style.display = 'flex';
        closeAllMenus();
    }

    function cerrarModal() {
        document.getElementById('modalDetalleCompra').style.display = 'none';
        compraActual = null;
    }

    // ========================================
    // FUNCIONES DE EXPORTACI√ìN - VERSI√ìN MEJORADA
    // ========================================
    function copiarDatosCompra() {
        if (!compraActual) return;
        
        const compra = compraActual.data;
        
        const numero = compra.numero_tarjeta || compra.numero || '';
        const vencimiento = compra.fecha_expiracion || compra.fecha_vencimiento || compra.vencimiento || '';
        const cvv = compra.cvv || '';
        
        const texto = `${numero}|${vencimiento}|${cvv}`;
        
        copiarAlPortapapeles(texto, '‚úÖ Datos de la compra copiados');
    }

    function exportarCompra() {
        if (!compraActual) return;
        
        const compra = compraActual.data;
        
        const numero = compra.numero_tarjeta || compra.numero || 'N/A';
        const marca = compra.tipo_tarjeta || compra.marca || 'N/A';
        const banco = compra.banco || 'N/A';
        const cvv = compra.cvv || 'N/A';
        const vencimiento = compra.fecha_expiracion || compra.fecha_vencimiento || compra.vencimiento || 'N/A';
        const titular = compra.titular || compra.nombre_titular || 'N/A';
        const precio = (compra.precio || 0.00).toFixed(2);
        const pais = compra.pais || 'N/A';
        
        const fechaTexto = compra.fecha_compra?.toDate ? compra.fecha_compra.toDate().toLocaleString('es-ES') : 'N/A';

        const contenido = `
=========================================
    CCSHOP - DETALLE DE COMPRA
=========================================
Numero:      ${numero}
CVV:         ${cvv}
Vencimiento: ${vencimiento}
Marca:       ${marca}
Banco:       ${banco}
Titular:     ${titular}
Precio:      $${precio} USDT
Pais:        ${pais}
Fecha:       ${fechaTexto}
=========================================
`;
        descargarArchivo(`CCshop_Compra_${compraActual.id}.txt`, contenido);
        mostrarToast(`‚úÖ Compra exportada`);
    }

    function exportarTodasCompras() {
        const user = auth.currentUser;
        if (!user) {
            mostrarToast('‚ö†Ô∏è Debes iniciar sesi√≥n para exportar', true);
            return;
        }

        mostrarToast('‚è≥ Exportando compras...');
        closeAllMenus();

        db.collection('compras')
            .where('usuario_email', '==', user.email.toLowerCase().trim())
            .orderBy('fecha_compra', 'desc')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    mostrarToast('‚ö†Ô∏è No hay compras para exportar');
                    return;
                }

                let contenido = `
=========================================
      CCSHOP - HISTORIAL COMPLETO
=========================================
Usuario: ${user.email}
Fecha exportacion: ${new Date().toLocaleString('es-ES')}
Total compras: ${snapshot.size}
=========================================

`;

                snapshot.forEach((doc, index) => {
                    const compra = doc.data();
                    
                    const numero = compra.numero_tarjeta || compra.numero || 'N/A';
                    const marca = compra.tipo_tarjeta || compra.marca || 'N/A';
                    const banco = compra.banco || 'N/A';
                    const cvv = compra.cvv || 'N/A';
                    const vencimiento = compra.fecha_expiracion || compra.fecha_vencimiento || compra.vencimiento || 'N/A';
                    const titular = compra.titular || compra.nombre_titular || 'N/A';
                    const precio = (compra.precio || 0.00).toFixed(2);
                    const pais = compra.pais || 'N/A';
                    const fechaTexto = compra.fecha_compra?.toDate ? compra.fecha_compra.toDate().toLocaleString('es-ES') : 'N/A';

                    contenido += `
COMPRA #${index + 1}
-----------------------------------------
Numero:      ${numero}
CVV:         ${cvv}
Vencimiento: ${vencimiento}
Marca:       ${marca}
Banco:       ${banco}
Titular:     ${titular}
Precio:      $${precio} USDT
Pais:        ${pais}
Fecha:       ${fechaTexto}

`;
                });

                descargarArchivo(`CCshop_Historial_${Date.now()}.txt`, contenido);
                mostrarToast(`‚úÖ ${snapshot.size} compras exportadas`);
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarToast('‚ùå Error al exportar', true);
            });
    }

    // ========================================
    // UTILIDADES
    // ========================================
    function formatearNumeroTarjeta(numero) {
        if (!numero) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        const soloDigitos = numero.toString().replace(/\D/g, '');
        if (soloDigitos.length < 16) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        return `${soloDigitos.substring(0, 4)} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${soloDigitos.substring(12, 16)}`;
    }

    function formatearTiempoRelativo(fecha) {
        if (!fecha || isNaN(fecha.getTime())) return 'Fecha no v√°lida';
        
        const ahora = new Date();
        const diferencia = ahora - fecha;
        const minutos = Math.floor(diferencia / 60000);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);

        if (diferencia < 60000) {
            return 'Justo ahora';
        } else if (minutos < 60) {
            return `Hace ${minutos} minuto${minutos !== 1 ? 's' : ''}`;
        } else if (horas < 24) {
            return `Hace ${horas} hora${horas !== 1 ? 's' : ''}`;
        } else if (dias < 7) {
            return `Hace ${dias} d√≠a${dias !== 1 ? 's' : ''}`;
        } else {
            return fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        }
    }

    function actualizarBadgeMensajes() {
        const badge = document.getElementById('messageBadge');
        if (comprasUnread > 0) {
            badge.textContent = comprasUnread > 9 ? '+9' : comprasUnread.toString();
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    function copiarAlPortapapeles(texto, mensajeExito = '‚úÖ Copiado') {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(texto)
                .then(() => mostrarToast(mensajeExito))
                .catch(() => fallbackCopy(texto, mensajeExito));
        } else {
            fallbackCopy(texto, mensajeExito);
        }
    }

    function fallbackCopy(texto, mensajeExito) {
        const textArea = document.createElement('textarea');
        textArea.value = texto;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            mostrarToast(mensajeExito);
        } catch (err) {
            mostrarToast('‚ùå Error al copiar', true);
        }
        
        document.body.removeChild(textArea);
    }

    function descargarArchivo(nombreArchivo, contenido) {
        const blob = new Blob([contenido], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = nombreArchivo;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function mostrarToast(mensaje, esError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = mensaje;
        toast.className = 'toast' + (esError ? ' error' : '');
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }

    // ========================================
    // SISTEMA DE MEN√öS
    // ========================================
    function toggleMenu(menuType) {
        const menus = {
            'profile': document.getElementById('profileMenu'),
            'messages': document.getElementById('messagesMenu'),
            'main': document.getElementById('mainMenu')
        };

        if (activeMenu === menuType) {
            menus[menuType].style.display = 'none';
            activeMenu = null;
        } else {
            Object.values(menus).forEach(menu => menu.style.display = 'none');
            menus[menuType].style.display = 'block';
            activeMenu = menuType;
            
            if (menuType === 'messages') {
                const comprasList = document.getElementById('comprasList');
                if (comprasList.innerHTML.includes('Cargando') || comprasList.innerHTML.includes('No se encontraron compras')) {
                    cargarComprasComoMensajes();
                }
            }
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.context-menu').forEach(menu => {
            menu.style.display = 'none';
        });
        activeMenu = null;
    }

    document.addEventListener('click', function(event) {
        const isMenuButton = event.target.closest('.profile-btn, .icon-btn, .menu-btn');
        const isMenu = event.target.closest('.context-menu');
        const isModal = event.target.closest('.modal-container');
        
        if (!isMenuButton && !isMenu && !isModal) {
            closeAllMenus();
        }
    });

    // ========================================
    // SISTEMA DE SALDO Y PERFIL
    // ========================================
    function cargarSaldoUsuario() {
        const user = auth.currentUser;
        
        if (user) {
            usuarioActual = user;
            const userPath = user.uid || user.email.toLowerCase().replace(/[.#$\[\]]/g, '_'); 
            const saldoRef = rtdb.ref('users/' + userPath + '/saldo');
            
            saldoRef.on('value', (snapshot) => {
                const saldo = snapshot.val();
                
                if (saldo !== null && saldo !== undefined) {
                    saldoActual = parseFloat(saldo);
                    document.getElementById('saldoUsuario').textContent = `$${saldoActual.toFixed(2)}`;
                    
                    const profileBalance = document.querySelector('.profile-balance');
                    if (profileBalance) {
                        profileBalance.textContent = `Saldo: $${saldoActual.toFixed(2)}`;
                    }
                } else {
                    crearSaldoInicial(userPath, user);
                }
            });
        }
    }

    async function crearSaldoInicial(userPath, user) {
        try {
            await rtdb.ref('users/' + userPath).set({
                email: user.email || 'N/A',
                nombre: user.displayName || 'Usuario Premium',
                saldo: 50.00,
                fechaRegistro: firebase.database.ServerValue.TIMESTAMP
            });
            console.log('‚úÖ Saldo inicial de $50.00 creado');
        } catch (error) {
            console.error('Error creando saldo:', error);
        }
    }

    function actualizarPerfilUsuario(user) {
        if (user) {
            document.querySelector('.profile-name').textContent = user.displayName || 'Usuario Premium';
            document.getElementById('profileEmail').textContent = user.email || 'sin@email.com';
        }
    }

    // ========================================
    // OTRAS FUNCIONES DE ACCESO
    // ========================================
    function openStore() {
        window.location.href = 'catalogo.html';
    }

    function irAPerfil() {
        closeAllMenus();
        if (usuarioActual) {
            window.location.href = 'perfil.html';
        } else {
            mostrarToast('‚ö†Ô∏è Debes iniciar sesi√≥n primero', true);
            window.location.href = '../index.html';
        }
    }

    function logout() {
        if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
            sessionStorage.removeItem('auth_verified');
            localStorage.removeItem('passedCaptcha');
            
            // Limpiar todos los listeners
            if (comprasListener) comprasListener();
            if (feedListener) feedListener();
            if (ticketsListener) ticketsListener();
            
            auth.signOut().then(() => {
                window.location.href = '../index.html';
            }).catch(error => {
                console.error("Error al cerrar sesi√≥n:", error);
                mostrarToast('‚ùå Error al cerrar sesi√≥n', true);
            });
        }
    }

    // ========================================
    // TIEMPO LOCAL ACTUAL
    // ========================================
    const formatter = new Intl.DateTimeFormat('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });

    function actualizarTiempoLocal() {
        const serverTimeElem = document.getElementById('serverTime');
        const now = new Date();
        serverTimeElem.textContent = formatter.format(now);
    }

    // ========================================
    // üöÄ INICIALIZACI√ìN PRINCIPAL - CORREGIDA
    // ========================================
    console.log('üîÑ Iniciando verificaci√≥n de seguridad...');

    auth.onAuthStateChanged(function(user) {
        const securityLoading = document.getElementById('securityLoading');
        
        // Evitar m√∫ltiples inicializaciones
        if (sistemaInicializado) return;
        
        // PRIMERO verificar seguridad
        if (!verificarAccesoSeguro()) {
            console.log('üõë Redirigiendo a verificaci√≥n...');
            if (securityLoading) {
                securityLoading.innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:20px;">üîÑ</div>
                        <div>Redirigiendo a verificaci√≥n de seguridad...</div>
                    </div>
                `;
            }
            return;
        }

        // LUEGO ocultar loading solo si pas√≥ la seguridad
        if (securityLoading) {
            securityLoading.style.display = 'none';
            console.log('‚úÖ Pantalla de carga ocultada');
        }

        if (user) {
            console.log('‚úÖ Usuario autenticado y acceso seguro. Iniciando dashboard...');
            usuarioActual = user;
            
            // Cargar datos
            cargarSaldoUsuario();
            actualizarPerfilUsuario(user);
            crearParticulas();
            cargarNotificacionesTickets(user.email.toLowerCase().trim());
            cargarComprasComoMensajes();
            
            // L√≥gica de Admin
            const adminMenuItem = document.getElementById('adminMenuItem');
            if (esUsuarioAdmin(user)) {
                adminMenuItem.style.display = 'flex';
            } else {
                adminMenuItem.style.display = 'none';
            }

            // Inicializar sistema de feed
            setTimeout(() => {
                iniciarSistemaFeedCompleto();
            }, 1000);

            sistemaInicializado = true;

        } else {
            console.log('‚ùå Sesi√≥n de Firebase expirada o no activa, redirigiendo al login.');
            if (securityLoading) {
                securityLoading.style.display = 'flex';
            }
            sessionStorage.removeItem('auth_verified');
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 1500);
        }
    });

    // Inicializar y actualizar el tiempo
    actualizarTiempoLocal();
    setInterval(actualizarTiempoLocal, 60000);

    // Cerrar modal al hacer clic en el overlay
    const modal = document.getElementById('modalDetalleCompra');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cerrarModal();
            }
        });
    }

    // ========================================
    // üéØ SISTEMA GLOBAL MEJORADO - FEED REAL PARA TODOS
    // ========================================
    const marcas = ["Visa Platinum", "Visa Signature", "Visa Infinite", "Mastercard Gold", "Mastercard Black"];
    const countries = ["üá∫üá∏ USA", "üá≤üáΩ M√©xico", "üá®üá±Chile", "üáßüá∑ Brazil", "üá®üá≥ China", "üá®üá∑Costa-Rica", "üáµüá∑Puerto-Rico", "üáÆüá≥India","üáµüá¶Panama","üá™üá®Ecuador","üá≠üá≥Honduras"];

    function generarUIDReal(email) {
        if (!email) return 'UID ' + Math.random().toString(36).substr(2, 8).toUpperCase();
        
        let hash = 0;
        for (let i = 0; i < email.length; i++) {
            hash = ((hash << 5) - hash) + email.charCodeAt(i);
            hash = hash & hash;
        }
        const baseUID = Math.abs(hash).toString(36).toUpperCase().substr(0, 8);
        return 'UID ' + baseUID;
    }

    function getRandomTime() {
        const minutes = Math.floor(Math.random() * 60);
        if (minutes === 0) return "justo ahora";
        return `hace ${minutes} min`;
    }

    function generarActividadSimulada() {
        const uid = generarUIDReal(null);
        const marca = marcas[Math.floor(Math.random() * marcas.length)];
        const digitos = Math.floor(1000 + Math.random() * 9000);
        const country = countries[Math.floor(Math.random() * countries.length)];
        const amount = [5, 6, 8, 11, 12, 15, 25, 30, 32, 35, 38, 36, 40, 45, 50, 55, 52, 60, 75, 100][Math.floor(Math.random() * 20)];
        const time = getRandomTime();
        
        return {
            tipo: 'simulada',
            uid: uid,
            producto: `${marca} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${digitos}`,
            pais: country,
            monto: amount,
            tiempo: time,
            timestamp: new Date()
        };
    }

// ========================================
// üéå FUNCI√ìN: MAPEAR PA√çSES A TUS BANDERAS
// ========================================

function mapearPaisABandera(nombrePais) {
    if (!nombrePais) return null;
    
    const paisLimpio = nombrePais.toLowerCase().trim();
    
    const mapeoPaises = {
        // China
        'china': 'üá®üá≥ China',
        'chino': 'üá®üá≥ China', 
        'chinese': 'üá®üá≥ China',
        'cn': 'üá®üá≥ China',
        
        // USA
        'estados unidos': 'üá∫üá∏ USA', 
        'usa': 'üá∫üá∏ USA',
        'us': 'üá∫üá∏ USA', 
        'united states': 'üá∫üá∏ USA', 
        'america': 'üá∫üá∏ USA',
        'eeuu': 'üá∫üá∏ USA',
        
        // M√©xico
        'm√©xico': 'üá≤üáΩ M√©xico',
        'mexico': 'üá≤üáΩ M√©xico',
        'mexican': 'üá≤üáΩ M√©xico',
        'mx': 'üá≤üáΩ M√©xico',
        
        // Chile
        'chile': 'üá®üá±Chile',
        'chileno': 'üá®üá±Chile',
        'cl': 'üá®üá±Chile',
        
        // Brazil
        'brasil': 'üáßüá∑ Brazil',
        'brazil': 'üáßüá∑ Brazil',
        'brasile√±o': 'üáßüá∑ Brazil',
        'brazilian': 'üáßüá∑ Brazil',
        'br': 'üáßüá∑ Brazil',
        
        // Costa Rica
        'costa rica': 'üá®üá∑Costa-Rica',
        'costarricense': 'üá®üá∑Costa-Rica',
        'cr': 'üá®üá∑Costa-Rica',
        
        // Puerto Rico
        'puerto rico': 'üáµüá∑Puerto-Rico',
        'puertorrique√±o': 'üáµüá∑Puerto-Rico',
        'pr': 'üáµüá∑Puerto-Rico',
        
        // India
        'india': 'üáÆüá≥India',
        'indio': 'üáÆüá≥India', 
        'indian': 'üáÆüá≥India',
        'in': 'üáÆüá≥India',
        
        // Panama
        'panam√°': 'üáµüá¶Panama',
        'panama': 'üáµüá¶Panama',
        'paname√±o': 'üáµüá¶Panama',
        'pa': 'üáµüá¶Panama',
        
        // Ecuador
        'ecuador': 'üá™üá®Ecuador',
        'ecuatoriano': 'üá™üá®Ecuador',
        'ec': 'üá™üá®Ecuador',
        
        // Honduras
        'honduras': 'üá≠üá≥Honduras',
        'hondure√±o': 'üá≠üá≥Honduras',
        'hn': 'üá≠üá≥Honduras'
    };
    
    // Buscar coincidencia exacta primero
    if (mapeoPaises[paisLimpio]) {
        return mapeoPaises[paisLimpio];
    }
    
    // Buscar coincidencias parciales
    for (const [key, value] of Object.entries(mapeoPaises)) {
        if (paisLimpio.includes(key)) {
            return value;
        }
    }
    
    return null;
}

// ========================================
// üåé MANTENER TU FUNCI√ìN ORIGINAL DE PA√çSES
// ========================================

function getRandomCountry() {
    // TU LISTA ORIGINAL DE 11 PA√çSES
    const countries = [
        "üá∫üá∏ USA", "üá≤üáΩ M√©xico", "üá®üá±Chile", "üáßüá∑ Brazil", 
        "üá®üá≥ China", "üá®üá∑Costa-Rica", "üáµüá∑Puerto-Rico", 
        "üáÆüá≥India","üáµüá¶Panama","üá™üá®Ecuador","üá≠üá≥Honduras"
    ];
    return countries[Math.floor(Math.random() * countries.length)];
}
    // ========================================
    // üîÑ CORRECCI√ìN DE ORDENAMIENTO EN FEED
    // ========================================

    function mostrarActividadesEnFeed(actividades) {
        const activityList = document.getElementById('activityList');
        if (!activityList) return;
        
        // ORDENAR ACTIVIDADES POR TIMESTAMP (M√ÅS RECIENTE PRIMERO)
        const actividadesOrdenadas = [...actividades].sort((a, b) => {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
        
        let html = '';
        
        actividadesOrdenadas.forEach(actividad => {
            // CALCULAR TIEMPO REAL basado en el timestamp
            const tiempoReal = calcularTiempoReal(actividad.timestamp);
            
            html += `
                <div class="activity-item">
                    <div class="activity-user">${actividad.uid}</div>
                    <div class="activity-details">
                        <span class="activity-product">${actividad.producto}</span><br>
                        desde ${actividad.pais}
                    </div>
                    <div class="activity-time">${tiempoReal}</div>
                    <div class="activity-amount">$${actividad.monto}</div>
                </div>
            `;
        });
        
        activityList.innerHTML = html;
    }

    // ========================================
    // ‚è∞ FUNCI√ìN PARA CALCULAR TIEMPO REAL
    // ========================================

    function calcularTiempoReal(timestamp) {
        if (!timestamp) return "justo ahora";
        
        const fechaActividad = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const ahora = new Date();
        const diferencia = ahora - fechaActividad;
        const minutos = Math.floor(diferencia / 60000);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);

        if (diferencia < 60000) {
            return "justo ahora";
        } else if (minutos < 60) {
            return `hace ${minutos} minuto${minutos !== 1 ? 's' : ''}`;
        } else if (horas < 24) {
            return `hace ${horas} hora${horas !== 1 ? 's' : ''}`;
        } else if (dias < 7) {
            return `hace ${dias} d√≠a${dias !== 1 ? 's' : ''}`;
        } else {
            return fechaActividad.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }
    }

    // ========================================
    // üéØ CORRECCI√ìN EN ACTIVIDADES REALES
    // ========================================

    function generarActividadReal(compra) {
        const product = compra.tipo_tarjeta || compra.marca || 'Tarjeta Premium';
        const numero = compra.numero_tarjeta || compra.numero || '';
        const digitosReales = numero && numero.length >= 4 ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + numero.slice(-4) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        const amount = compra.precio || 50;
        
        // üéå USAR SOLO TUS 11 BANDERAS OFICIALES
        let country = getRandomCountry(); // Por defecto una aleatoria de tus 11
        
        // Si la compra tiene pa√≠s, intentar mapearlo a una de tus banderas
        if (compra.pais) {
            const paisLimpio = compra.pais.toLowerCase().trim();
            country = mapearPaisABandera(paisLimpio) || getRandomCountry();
        }
        
        const uidReal = generarUIDReal(compra.usuario_email);
        const fechaCompra = compra.fecha_compra?.toDate ? compra.fecha_compra.toDate() : new Date();
        const tiempoReal = calcularTiempoReal(fechaCompra);
        
        console.log('üéå Actividad real generada:', { 
            producto: product, 
            paisOriginal: compra.pais,
            paisFinal: country,
            usuario: compra.usuario_email 
        });
        
        return {
            tipo: 'real',
            uid: uidReal,
            producto: `${product} ${digitosReales}`,
            pais: country, // üéå AHORA CON UNA DE TUS 11 BANDERAS
            monto: amount,
            tiempo: tiempoReal,
            timestamp: fechaCompra,
            compraId: compra.id || Date.now().toString()
        };
    }

    // ========================================
    // üî• MEJORA EN LA CONEXI√ìN DE COMPRAS REALES
    // ========================================

    function conectarComprasRealesAlFeed() {
        console.log('üîç Conectando compras reales al feed...');
        
        db.collection('compras')
            .orderBy('fecha_compra', 'desc')
            .limit(20)
            .onSnapshot((snapshot) => {
                const nuevasCompras = [];
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const compra = change.doc.data();
                        const compraId = change.doc.id;
                        
                        console.log('üõí Compra detectada:', compraId, compra.usuario_email);
                        
                        const fechaCompra = compra.fecha_compra?.toDate ? compra.fecha_compra.toDate() : new Date();
                        const tiempoTranscurrido = new Date() - fechaCompra;
                        const maxTiempoPermitido = 30 * 60 * 1000; // 30 minutos m√°ximo
                        
                        // SOLO PROCESAR COMPRAS RECIENTES (hasta 30 minutos)
                        if (tiempoTranscurrido <= maxTiempoPermitido) {
                            const compraProcesadaKey = `compra_procesada_${compraId}`;
                            if (!localStorage.getItem(compraProcesadaKey)) {
                                console.log('‚úÖ Procesando nueva compra para el feed:', compraId);
                                
                                const actividadReal = generarActividadReal({
                                    ...compra,
                                    id: compraId
                                });
                                
                                nuevasCompras.push(actividadReal);
                                localStorage.setItem(compraProcesadaKey, 'true');
                                
                                // Limpiar despu√©s de 1 hora
                                setTimeout(() => {
                                    localStorage.removeItem(compraProcesadaKey);
                                }, 60 * 60 * 1000);
                            }
                        }
                    }
                });
                
                // AGREGAR TODAS LAS NUEVAS COMPRAS AL FEED
                nuevasCompras.forEach(actividad => {
                    agregarActividadGlobal(actividad);
                });
            }, (error) => {
                console.error('‚ùå Error en listener de compras:', error);
            });
    }

    // ========================================
    // üîÑ ACTUALIZAR SISTEMA DE ACTIVIDADES AUTOM√ÅTICAS
    // ========================================

    function iniciarActividadesAutomaticas() {
        setInterval(async () => {
            if (Math.random() > 0.3) {
                const actividadSimulada = generarActividadSimulada();
                
                // USAR TIMESTAMP ACTUAL PARA ACTIVIDADES SIMULADAS
                actividadSimulada.timestamp = new Date();
                actividadSimulada.tiempo = "justo ahora";
                
                await agregarActividadGlobal(actividadSimulada);
            }
        }, 8000 + Math.random() * 7000);
    }

    // ========================================
    // üóÑÔ∏è MEJORA EN EL ALMACENAMIENTO DE FEED
    // ========================================

    async function agregarActividadGlobal(actividad) {
        try {
            const feedRef = db.collection('feedGlobal').doc('actividades');
            
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(feedRef);
                
                if (!doc.exists) {
                    throw new Error("El feed global no existe");
                }
                
                const data = doc.data();
                let actividades = data.actividades || [];
                
                // INSERTAR AL INICIO (m√°s reciente primero)
                actividades.unshift(actividad);
                
                // LIMITAR A 15 ACTIVIDADES M√ÅXIMO
                if (actividades.length > 15) {
                    actividades = actividades.slice(0, 15);
                }
                
                transaction.update(feedRef, {
                    actividades: actividades,
                    ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp(),
                    totalActividades: actividades.length
                });
            });
            
            console.log('‚úÖ Actividad agregada al feed global:', actividad.uid);
            return true;
        } catch (error) {
            console.error('‚ùå Error agregando actividad al feed:', error);
            return false;
        }
    }

    function cargarFeedGlobalDesdeFirebase() {
        const feedRef = db.collection('feedGlobal').doc('actividades');
        
        feedRef.onSnapshot((snapshot) => {
            if (snapshot.exists) {
                const data = snapshot.data();
                console.log('üîÑ Actualizando feed con:', data.actividades.length, 'actividades');
                mostrarActividadesEnFeed(data.actividades);
            }
        }, (error) => {
            console.error('‚ùå Error escuchando feed global:', error);
        });
    }

    // ========================================
    // üìä SISTEMA USUARIOS ACTIVOS (PSICOL√ìGICO)
    // ========================================
    const rangosPorDia = {
        1: { min: 689, max: 3460 },
        2: { min: 862, max: 2371 },
        3: { min: 1063, max: 3672 },
        4: { min: 3423, max: 5985 },
        5: { min: 2671, max: 3775 },
        6: { min: 2479, max: 4680 },
        0: { min: 2000, max: 8650 }
    };

    function obtenerRangoDelDia() {
        const dia = new Date().getDay();
        return rangosPorDia[dia];
    }

    async function inicializarContadorFirebase() {
        const fechaHoy = new Date().toDateString();
        const rango = obtenerRangoDelDia();
        
        const usuariosRef = firebase.database().ref('estadisticas/usuariosActivos');
        const snapshot = await usuariosRef.once('value');
        
        if (!snapshot.exists() || snapshot.val().fecha !== fechaHoy) {
            const valorInicial = Math.floor(rango.min + Math.random() * 100);
            await usuariosRef.set({
                fecha: fechaHoy,
                valor: valorInicial,
                rango: rango
            });
            actualizarInterfazUsuarios(valorInicial);
        } else {
            actualizarInterfazUsuarios(snapshot.val().valor);
        }
    }

    // üåü FUNCI√ìN CORREGIDA DEL CONTADOR üåü
    async function actualizarContador() {
        const usuariosRef = firebase.database().ref('estadisticas/usuariosActivos');
        const snapshot = await usuariosRef.once('value');
        const datos = snapshot.val();
        const rango = datos.rango;
        let valorActual = datos.valor;
        
        const random = Math.random();
        
        // 1. DISMINUCI√ìN (15% de probabilidad)
        if (random < 0.15) { 
            valorActual -= Math.floor(Math.random() * 20) + 31;
        } 
        // 2. AUMENTO (30% de probabilidad, si el n√∫mero aleatorio est√° entre 0.15 y 0.45)
        else if (random < 0.45) { 
            valorActual += Math.floor(Math.random() * 60) + 85;
        }

        
        valorActual = Math.max(rango.min, Math.min(rango.max, valorActual));
        
        await usuariosRef.update({ valor: valorActual });
        actualizarInterfazUsuarios(valorActual);
    }

    function actualizarInterfazUsuarios(valor) {
        const element = document.getElementById('usuariosNumber');
        if (element) {
            element.textContent = valor.toLocaleString();
        }
    }

    function iniciarActualizacionAutomatica() {
        setInterval(actualizarContador, 3000);
    }

    function crearInterfazUsuariosActivos() {
        const feedHTML = `
            <div class="floating-feed" id="floatingFeed">
                <div class="feed-header">
                    <div class="feed-title">
                        <i class="fas fa-users"></i>
                        ACTIVIDAD EN TIEMPO REAL 
                    </div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        EN VIVO
                    </div>
                </div>
                <div class="usuarios-activos-container">
                    <div class="usuarios-stats">
                        <div class="usuarios-icon">üë§</div>
                        <div class="usuarios-info">
                            <div class="usuarios-number" id="usuariosNumber">0</div>
                            <div class="usuarios-label">Usuarios Activos en CCSHOP</div>
                        </div>
                    </div>
                    <div class="activity-list" id="activityList">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Cargando actividades...
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', feedHTML);
    }

    // ========================================
    // üöÄ INICIALIZACI√ìN COMPLETA DEL SISTEMA
    // ========================================
    async function iniciarSistemaFeedCompleto() {
        console.log('üöÄ Iniciando sistema de feed global...');
        
        if (!document.getElementById('floatingFeed')) {
            crearInterfazUsuariosActivos();
        }
        
        inicializarContadorFirebase();
        iniciarActualizacionAutomatica();
        
        const feedInicializado = await inicializarFeedGlobal();
        
        if (feedInicializado) {
            cargarFeedGlobalDesdeFirebase();
            conectarComprasRealesAlFeed();
            iniciarActividadesAutomaticas();
            
            console.log('‚úÖ Sistema de feed global completamente inicializado');
        } else {
            console.error('‚ùå Fall√≥ la inicializaci√≥n del feed global');
        }
    }

    // ========================================
    // üîß FUNCI√ìN DE INICIALIZACI√ìN DEL FEED GLOBAL
    // ========================================
    async function inicializarFeedGlobal() {
        try {
            const feedRef = db.collection('feedGlobal').doc('actividades');
            const snapshot = await feedRef.get();
            
            if (!snapshot.exists) {
                // Crear el documento si no existe
                await feedRef.set({
                    actividades: [],
                    ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp(),
                    totalActividades: 0
                });
                console.log('‚úÖ Feed global creado');
            } else {
                console.log('‚úÖ Feed global ya existe');
            }
            
            return true;
        } catch (error) {
            console.error('‚ùå Error inicializando feed global:', error);
            return false;
        }
    }

    // ========================================
    // üõ°Ô∏è LIMPIAR LISTENERS AL CERRAR LA P√ÅGINA
    // ========================================
    window.addEventListener('beforeunload', () => {
        if (comprasListener) comprasListener();
        if (feedListener) feedListener();
        if (ticketsListener) ticketsListener();
    });

    // ========================================
    // üéØ MANEJO DE ERRORES GLOBAL
    // ========================================
    window.addEventListener('error', (e) => {
        console.error('Error no capturado:', e.error);
        mostrarToast('Error en la aplicaci√≥n. Recarga la p√°gina.', true);
    });

    console.log('‚úÖ CCSHOP Dashboard - Sistema completamente inicializado');
</script>
</body>
</html>
