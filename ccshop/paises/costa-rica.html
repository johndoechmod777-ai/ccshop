<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventario Tarjetas Costa Rica ‚Äì Mira</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><defs><linearGradient id='text' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23ff0000'/><stop offset='100%' stop-color='%23cc0000'/></linearGradient></defs><path d='M8 8 L24 8 L24 24 L8 24 Z' transform='rotate(45 16 16)' fill='none' stroke='%23ff0000' stroke-width='1.5'/><text x='12' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text><text x='20' y='20' text-anchor='middle' fill='url(%23text)' font-family='Arial' font-weight='bold' font-size='12'>C</text></svg>">
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* VIDEO DE FONDO */
        #videoFondo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }
        
        body {
            background: #111;
            color: #fff;
            font-family: 'Arial', sans-serif;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.85);
            margin-bottom: 30px;
            /* Tema CR - Borde Azul y Rojo */
            border-bottom: 3px solid #000080; /* Azul oscuro CR */
            border-left: 3px solid #E53935; /* Rojo bandera CR */
            border-radius: 12px;
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0, 0, 128, 0.5);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .back-button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            /* Tema CR - Rojo Intenso */
            background: linear-gradient(135deg, #E53935, #A30000);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 15px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(229, 57, 53, 0.5);
        }
        
        #btnSaldo {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #00a86b, #00c853);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
            transition: all 0.3s ease;
        }
        
        h1 {
            color: #ffcc00; /* Dorado Cyber */
            margin: 0;
            font-size: 30px;
            text-shadow: 0 2px 10px rgba(255, 204, 0, 0.8);
        }

        /* --- ESTILOS DE LISTA Y TARJETA --- */
        #listaTarjetas {
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: center;
            min-height: 1200px; 
        }
        
        .card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .card {
            width: 400px;
            height: 240px;
            /* Fondo CR (Gris oscuro/negro) */
            background: #2a2a2a; 
            border-radius: 16px;
            padding: 15px;
            position: relative;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.8);
            /* Borde CR (Azul Oscuro) */
            border: 1px solid rgba(0, 0, 128, 0.6); 
            overflow: hidden;
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(5px);
        }
        
        .card::before {
            /* S√çMBOLO ADAPTADO: Escudo CR (usando una "C" estilizada) */
            content: 'üá®üá∑'; 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            opacity: 0.3;
            z-index: 0;
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: 1;
        }
        
        .card-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chip-real {
            width: 55px;
            height: 42px;
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
            border-radius: 6px;
            /* Borde Chip CR (Rojo) */
            border: 1px solid rgba(229, 57, 53, 0.8);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        
        .card-logo {
            width: 85px;
            height: 55px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
        }

        .visa-logo { background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/800px-Visa_Inc._logo.svg.png'); }
        .mastercard-logo { background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/800px-Mastercard-logo.svg.png'); }
        .diners-logo { background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Diners_Club_Logo3.svg/800px-Diners_Club_Logo3.svg.png'); }
        .discover-logo { background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Discover_Card_logo.svg/800px-Discover_Card_logo.svg.png'); }

        .card-number {
            font-size: 22px;
            letter-spacing: 3px;
            font-weight: bold;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9);
            margin: 8px 0;
            color: #E53935; /* Rojo CR */
            font-family: 'Courier New', monospace;
            text-align: center;
            /* Fondo N√∫mero CR (Azul Oscuro) */
            background: rgba(0, 0, 80, 0.85); 
            padding: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .card-holder {
            font-size: 16px;
            margin: 5px 0;
            color: #ffffff; 
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: bold;
            text-align: left;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.9);
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 5px;
        }

        .bank-name, .cvv-info, .exp-label, .exp-value {
            color: #ffffff; 
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
            font-weight: bold;
        }

        .card-status {
            width: 400px;
            padding: 12px;
            margin-top: 10px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .status-available {
            background: linear-gradient(135deg, #00a86b, #00c853);
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
            animation: pulse 2s infinite;
        }
        
        .status-sold {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(0, 200, 83, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4); }
        }
        
        .buy-button {
            width: 400px;
            padding: 16px;
            margin-top: 12px;
            border: none;
            border-radius: 12px;
            /* Bot√≥n Comprar CR (Azul/Rojo) */
            background: linear-gradient(90deg, #000080, #E53935);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 17px;
            box-shadow: 0 6px 20px rgba(0, 0, 128, 0.5);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .buy-button:disabled {
            background: linear-gradient(135deg, #666, #888);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* --- ESTILOS PANTALLA DE CARGA CON BANDERA CR (Dise√±o Duro üî•) --- */
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ffcc00;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            transition: opacity 0.5s ease-out;
        }

        .flag-container {
            width: 350px; 
            height: 210px; /* Proporci√≥n 3:5 (350 / 1.666) */
            position: relative; 
            margin-bottom: 30px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* Estilo para las franjas - CR (Azul, Blanco, Rojo, Blanco, Azul) */
        .stripe-cr {
            position: absolute;
            width: 100%;
            height: 20%; 
            opacity: 0;
            animation: stripe-slide-in 0.8s ease-out forwards;
        }

        /* Definici√≥n de colores y posiciones de las franjas CR */
        .stripe-cr:nth-child(1) { background: #000080; top: 0%; animation-delay: 0s; transform: translateY(-100%); } /* Azul */
        .stripe-cr:nth-child(2) { background: white; top: 20%; animation-delay: 0.1s; transform: translateX(100%); }
        .stripe-cr:nth-child(3) { background: #E53935; top: 40%; animation-delay: 0.2s; transform: translateX(-100%); } /* Rojo Central */
        .stripe-cr:nth-child(4) { background: white; top: 60%; animation-delay: 0.3s; transform: translateX(100%); }
        .stripe-cr:nth-child(5) { background: #000080; top: 80%; animation-delay: 0.4s; transform: translateY(100%); } /* Azul */
        
        @keyframes stripe-slide-in {
            0% { opacity: 0; transform: none; }
            100% { opacity: 1; transform: translate(0, 0); }
        }

        /* ESCUDO (Colocado en el centro de la franja ROJA - 40% a 60% top) */
        .coat-of-arms {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 35px;
            color: #FFD700; /* Dorado */
            text-shadow: 0 0 5px #FFD700, 0 0 20px #FFD700, 0 0 40px #FFA500;
            opacity: 0;
            animation: neon-pulse-cr 1.5s infinite alternate 0.6s, fadeIn 0.5s ease-out forwards 0.5s; 
            z-index: 11;
        }

        /* Animaci√≥n Ne√≥n para el Escudo de CR */
        @keyframes neon-pulse-cr {
            0% { 
                opacity: 0.8; 
                transform: translate(-50%, -50%) scale(1);
                text-shadow: 0 0 5px #FFD700, 0 0 15px #FFD700;
            }
            100% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.05);
                text-shadow: 0 0 10px #FFD700, 0 0 30px #FFD700, 0 0 50px #FFA500;
            }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .loading-text {
            margin-top: 20px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* --- ESTILOS DE MODAL Y PAGINACI√ìN --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #000080; /* Borde de modal en Azul CR */
            text-align: center;
        }

        .card-data {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            text-align: left;
            color: #ffcc00; 
        }

        .data-item {
            margin: 10px 0;
            padding: 8px;
            background: #333;
            border-radius: 5px;
        }

        .data-label {
            color: #ccc;
            font-size: 12px;
        }

        .data-value {
            color: #ffcc00; 
            font-weight: bold;
            font-size: 16px;
        }

        .btn-modal {
            padding: 12px 30px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-success { background: #00a86b; color: white; }
        .btn-secondary { background: #666; color: white; }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin-top: 20px;
            gap: 20px;
        }

        .pagination-controls button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            /* Paginaci√≥n CR (Azul/Rojo) */
            background: linear-gradient(135deg, #000080, #E53935);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 128, 0.3);
        }

        .pagination-controls button:disabled {
            background: #333;
            color: #777;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .page-indicator {
            font-size: 18px;
            color: #ffcc00;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }
        
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="flag-container">
            <div class="stripe-cr"></div>
            <div class="stripe-cr"></div>
            <div class="stripe-cr"></div>
            <div class="stripe-cr"></div>
            <div class="stripe-cr"></div>
            <span class="coat-of-arms">‚Ç°</span> 
        </div>
        <div class="loading-text">Cargando inventario de tarjetas Costa Rica...</div>
    </div>

    <video id="videoFondo" autoplay muted loop>
        <source src="infinito.mp4" type="video/mp4">
        Tu navegador no soporta videos HTML5.
    </video>
    <div class="overlay"></div>

    <div id="compraModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">‚úÖ COMPRA EXITOSA</h2>
            <div class="card-data" id="modalCardData">
                </div>
            <p style="color: #ffff00; margin: 15px 0;">
                üìß <strong>Revisa tu correo electr√≥nico</strong><br>
                Hemos enviado los datos completos de la tarjeta a tu email registrado.
            </p>
            <div>
                <button class="btn-modal btn-success" onclick="cerrarModal()">Aceptar</button>
                <button class="btn-modal btn-secondary" onclick="reenviarEmail()">Reenviar Email</button>
            </div>
        </div>
    </div>

    <header>
        <div class="header-left">
            <a href="../catalogo.html" class="back-button">‚Üê Volver al Cat√°logo</a>
            <h1>üá®üá∑ Inventario Costa Rica</h1>
        </div>
        <button id="btnSaldo">Saldo USDT: <span id="saldo">0.00</span></button>
    </header>

    <main id="listaTarjetas"></main>

    <div class="pagination-controls">
        <button id="prevPage" onclick="prevPage()" disabled>‚Üê Anterior</button>
        <div id="pageIndicator" class="page-indicator">P√°gina 1</div>
        <button id="nextPage" onclick="nextPage()">Siguiente ‚Üí</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN Y VARIABLES ---
        // ** MANTENER LA CONFIGURACI√ìN DE FIREBASE IGUAL **
        const firebaseConfig = {
            apiKey: "AIzaSyD2tvQjJzh7ukTSyxzIQSo7GSpz7L8z11I",
            authDomain: "ccshop-realtime.firebaseapp.com",
            databaseURL: "https://ccshop-realtime-default-rtdb.firebaseio.com",
            projectId: "ccshop-realtime",
            storageBucket: "ccshop-realtime.appspot.com",
            messagingSenderId: "795626673305",
            appId: "1:795626673305:web:094dc265de1d4d1bc7d408"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const auth = firebase.auth();
        emailjs.init("qWfGHNJ4lphrdXcBH");

        let usuarioActual = null;
        let saldoActual = 0;
        let tarjetaComprada = null;

        const PAGE_SIZE = 30;
        let lastVisible = null; 
        let pageHistory = [null]; 
        let currentPage = 1;

        // --- FUNCI√ìN DE INICIALIZACI√ìN SINCRONIZADA ---
        document.addEventListener('DOMContentLoaded', function() {
            // El video debe ser "infinito.mp4"
            const video = document.getElementById('videoFondo');
            video.loop = true;
            video.muted = true;
            video.play();
            
            // 1. Promesa: Tiempo de la animaci√≥n visual (2.5 segundos)
            const animacionTerminada = new Promise(resolve => {
                setTimeout(resolve, 2500); 
            });

            // 2. Promesa: Carga de autenticaci√≥n y la primera p√°gina de tarjetas
            const cargaDatos = new Promise(resolve => {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        usuarioActual = user;
                        cargarSaldoRealTime();
                        cargarTarjetas(true).then(resolve).catch(resolve); 
                    } else {
                        console.log('‚ùå No hay usuario autenticado');
                        // TEXTO EN ESPA√ëOL
                        alert('‚ö†Ô∏è Debes iniciar sesi√≥n primero');
                        window.location.href = "../index.html";
                        resolve();
                    }
                });
            });

            // 3. Esperar que AMBAS (animaci√≥n y datos) finalicen
            Promise.all([animacionTerminada, cargaDatos])
                .then(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    // Ocultar la pantalla de carga suavemente
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        console.log('‚úÖ Carga finalizada y sincronizada.');
                    }, 500); 
                })
                .catch(error => {
                    console.error('‚ùå Error durante la carga inicial:', error);
                    document.getElementById('loading-screen').style.display = 'none';
                });
        });

        // --- FUNCIONES AUXILIARES ---

        function cargarSaldoRealTime() {
            if (!usuarioActual) return;
            const saldoRef = rtdb.ref('users/' + usuarioActual.uid + '/saldo');
            saldoRef.on('value', (snapshot) => {
                const saldo = snapshot.val();
                if (saldo !== null && saldo !== undefined) {
                    saldoActual = parseFloat(saldo);
                    document.getElementById('saldo').textContent = saldoActual.toFixed(2);
                    const saldoElement = document.getElementById('saldo');
                    saldoElement.style.color = '#ffff00';
                    saldoElement.style.fontSize = '18px';
                    setTimeout(() => {
                        saldoElement.style.color = '#ffffff';
                        saldoElement.style.fontSize = '16px';
                    }, 1000);
                } else {
                    crearSaldoInicial();
                }
            }, (error) => {
                console.error('‚ùå Error cargando saldo:', error);
                document.getElementById('saldo').textContent = 'Error';
            });
        }

        async function crearSaldoInicial() {
            if (!usuarioActual) return;
            try {
                await rtdb.ref('users/' + usuarioActual.uid).set({
                    comprador: usuarioActual.email,
                    nombre: usuarioActual.displayName || 'Usuario',
                    saldo: 50.00,
                    fechaRegistro: Date.now()
                });
            } catch (error) {
                console.error('‚ùå Error creando saldo inicial:', error);
            }
        }

        function formatearNombre(nombreCompleto) {
            // TEXTO EN ESPA√ëOL
            if (!nombreCompleto) return 'TITULAR NO DISPONIBLE';
            return nombreCompleto.toUpperCase();
        }

        function obtenerLogoMarca(marca) {
            if (!marca) return 'visa-logo';
            const marcaLower = marca.toLowerCase();
            if (marcaLower === 'visa') return 'visa-logo';
            if (marcaLower === 'mastercard') return 'mastercard-logo';
            if (marcaLower === 'diners' || marcaLower === 'diners club') return 'diners-logo';
            if (marcaLower === 'discover') return 'discover-logo';
            return 'visa-logo';
        }
        
        // --- FUNCI√ìN DE CARGA PRINCIPAL (OPTMIZADA) ---
        async function cargarTarjetas(isInitialLoad = false) {
            if (!usuarioActual) return;

            const cont = document.getElementById("listaTarjetas");
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            const pageIndicator = document.getElementById('pageIndicator');
            
            if (!isInitialLoad) {
                // TEXTO EN ESPA√ëOL
                cont.innerHTML = '<p style="color:#ffcc00; font-size: 20px; text-align: center; padding: 50px;">Cargando p√°gina...</p>';
            }

            try {
                // *** COLECCI√ìN ADAPTADA A "COSTA RICA" ***
                let query = db.collection("paises").doc("costarica").collection("cards") 
                    .where('vendida', '==', false)
                    .orderBy('precio', 'desc')
                    .limit(PAGE_SIZE);

                if (lastVisible) {
                    query = query.startAfter(lastVisible);
                }

                const snapshot = await query.get();
                cont.innerHTML = "";

                if (snapshot.empty) {
                    // TEXTO EN ESPA√ëOL
                    cont.innerHTML = '<p style="color:#ff4757; font-size: 20px; text-align: center; padding: 50px;">No hay m√°s tarjetas disponibles por el momento.</p>';
                    lastVisible = null;
                    nextButton.disabled = true;
                    if(currentPage === 1) prevButton.disabled = true; 
                    return;
                }

                snapshot.forEach(doc => {
                    const c = doc.data();
                    const marcaLogo = obtenerLogoMarca(c.marca);
                    const estaVendida = c.vendida === true;
                    
                    const numeroOculto = c.numero_formateado || `${c.bin} ****** ****`;
                    const nombreFormateado = formatearNombre(c.nombre);
                    
                    // TEXTO EN ESPA√ëOL
                    cont.innerHTML += `
                        <div class="card-container">
                            <div class="card">
                                <div class="card-content">
                                    <div class="card-top">
                                        <div class="chip-real"></div>
                                        <div class="card-logo ${marcaLogo}"></div>
                                    </div>
                                    <div class="card-number">${numeroOculto}</div>
                                    <div class="card-holder">${nombreFormateado}</div>
                                    <div class="card-info">
                                        <div>
                                            <div class="bank-name">${c.banco}</div>
                                            <div class="cvv-info">CVV: ***</div>
                                        </div>
                                        <div class="exp-date">
                                            <div class="exp-label">EXPIRA</div>
                                            <div class="exp-value">${c.fecha}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-status ${estaVendida ? 'status-sold' : 'status-available'}">
                                ${estaVendida ? 'üî¥ TARJETA VENDIDA' : 'üü¢ TARJETA DISPONIBLE'}
                            </div>
                            <button class="buy-button" 
                                    onclick="comprar('${doc.id}', ${c.precio})" 
                                    ${estaVendida ? 'disabled' : ''}>
                                ${estaVendida ? '‚ùå COMPRA NO DISPONIBLE' : `üí≥ COMPRAR ${c.precio} USDT`}
                            </button>
                        </div>`;
                });

                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                nextButton.disabled = snapshot.size < PAGE_SIZE;
                prevButton.disabled = currentPage === 1;
                // TEXTO EN ESPA√ëOL
                pageIndicator.textContent = `P√°gina ${currentPage}`; 

            } catch (error) {
                console.error("‚ùå Error al cargar tarjetas paginadas:", error);
                // TEXTO EN ESPA√ëOL
                cont.innerHTML = '<p style="color:#ff4757; font-size: 20px; text-align: center; padding: 50px;">Error al cargar las tarjetas. Intenta de nuevo.</p>';
                prevButton.disabled = true;
                nextButton.disabled = true;
                throw error; 
            }
        }
        
        // --- FUNCIONES DE PAGINACI√ìN ---
        function nextPage() {
            if (document.getElementById('nextPage').disabled) return;
            if (pageHistory.length === currentPage) {
                pageHistory.push(lastVisible);
            }
            currentPage++;
            lastVisible = pageHistory[currentPage - 1]; 
            cargarTarjetas();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevPage() {
            if (currentPage <= 1 || document.getElementById('prevPage').disabled) return;
            currentPage--;
            lastVisible = pageHistory[currentPage - 1];
            cargarTarjetas();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // --- FUNCI√ìN DE COMPRA Y MODAL ---

        async function comprar(idCard, precio) {
            if (!usuarioActual) { 
                // TEXTO EN ESPA√ëOL
                alert("‚ö†Ô∏è Debes iniciar sesi√≥n primero");
                window.location.href = "../index.html";
                return; 
            }

            if (saldoActual < precio) { 
                // TEXTO EN ESPA√ëOL
                alert(`‚ùå Saldo insuficiente.\n\nüí∞ Tu saldo: $${saldoActual.toFixed(2)}\nüí≥ Precio tarjeta: $${precio}\n\nRecarga tu wallet para continuar.`);
                window.location.href = "../pagos/wallet-usdt.html";
                return; 
            }

            // TEXTO EN ESPA√ëOL
            if (!confirm(`¬øConfirmar compra por ${precio} USDT?\n\nLos datos completos se enviar√°n a tu correo electr√≥nico.`)) {
                return;
            }

            try {
                // *** COLECCI√ìN ADAPTADA A "COSTA RICA" ***
                const doc = await db.collection("paises").doc("costarica").collection("cards").doc(idCard).get();
                const tarjetaData = doc.data();

                let nombreCompleto = tarjetaData.nombre;
                
                if (nombreCompleto && (nombreCompleto.includes('*') || nombreCompleto.includes('****'))) {
                    // TEXTO EN ESPA√ëOL
                    nombreCompleto = tarjetaData.nombre_real || tarjetaData.titular_completo || tarjetaData.nombre_completo || 'NOMBRE COMPLETO NO DISPONIBLE - Contactar soporte';
                }
                
                // *** COLECCI√ìN ADAPTADA A "COSTA RICA" ***
                await db.collection("paises").doc("costarica").collection("cards").doc(idCard)
                  .update({ 
                      vendida: true, 
                      comprador: usuarioActual.uid,
                      comprador_email: usuarioActual.email,
                      fecha_venta: new Date()
                  });

                const nuevoSaldo = saldoActual - precio;
                await rtdb.ref('users/' + usuarioActual.uid + '/saldo').set(nuevoSaldo);
                
                tarjetaComprada = {
                    ...tarjetaData,
                    numero_completo: tarjetaData.numero,
                    nombre_completo: nombreCompleto,
                    id: doc.id
                };
                
                const emailEnviado = await enviarEmailConfirmacion(tarjetaComprada);
                
                mostrarModalConfirmacion(tarjetaComprada, nuevoSaldo, emailEnviado);
                
                saldoActual = nuevoSaldo;
                document.getElementById('saldo').textContent = nuevoSaldo.toFixed(2);
                
                // Ocultar la tarjeta comprada
                setTimeout(() => {
                    const botonComprado = document.querySelector(`button[onclick*="${idCard}"]`);
                    if (botonComprado) {
                        const container = botonComprado.closest('.card-container');
                        if (container) {
                            container.style.display = 'none';
                        }
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error en la compra:', error);
                // TEXTO EN ESPA√ëOL
                alert("‚ùå Error en la compra: " + error.message);
            }
        }

        function getPaisActual() {
            // L√ìGICA ADAPTADA
            return 'costa_rica';
        }

        async function enviarEmailConfirmacion(tarjeta) {
            try {
                const compraData = {
                    usuario_id: usuarioActual.uid,
                    usuario_email: usuarioActual.email,
                    tarjeta_id: tarjeta.id,
                    pais: getPaisActual(),
                    marca: tarjeta.marca,
                    numero: tarjeta.numero_completo,
                    cvv: tarjeta.cvv,
                    fecha_vencimiento: tarjeta.fecha,
                    titular: tarjeta.nombre_completo,
                    banco: tarjeta.banco,
                    precio: tarjeta.precio,
                    fecha_compra: new Date(),
                    estado: 'completada',
                    email_enviado: false,
                    bin: tarjeta.bin,
                    final: tarjeta.final,
                    numero_formateado: `${tarjeta.bin} ****** ${tarjeta.final}`,
                    leido: false
                };

                const compraRef = await db.collection('compras').add(compraData);
                
                try {
                    const templateParams = {
                        to_email: usuarioActual.email,
                        usuario_nombre: usuarioActual.displayName || 'Cliente CCSHOP', // TEXTO EN ESPA√ëOL
                        tarjeta_marca: tarjeta.marca,
                        tarjeta_numero: tarjeta.numero_completo,
                        tarjeta_cvv: tarjeta.cvv,
                        tarjeta_fecha: tarjeta.fecha,
                        tarjeta_titular: tarjeta.nombre_completo,
                        tarjeta_banco: tarjeta.banco,
                        tarjeta_precio: tarjeta.precio,
                        fecha_compra: new Date().toLocaleDateString('es-ES'), // FORMATO DE FECHA EN ESPA√ëOL
                        compra_id: compraRef.id, 
                        from_name: "Soporte CCSHOP", // TEXTO EN ESPA√ëOL
                        reply_to: "soporte_ccshop@proton.me"
                    };

                    const emailResult = await emailjs.send(
                        'service_zgzl6vd', 
                        'template_dc5a2qw', 
                        templateParams
                    );
                    
                    await compraRef.update({ 
                        email_enviado: true,
                        email_fecha_envio: new Date()
                    });
                    
                    return true;
                    
                } catch (emailError) {
                    await compraRef.update({ 
                        email_enviado: false, 
                        email_error: emailError.text || emailError.message,
                        email_status: emailError.status || 'N/A'
                    });
                    
                    return false;
                }

            } catch (error) {
                return false;
            }
        }

        function mostrarModalConfirmacion(tarjeta, nuevoSaldo, emailEnviado) {
            const modal = document.getElementById('compraModal');
            const modalData = document.getElementById('modalCardData');
            
            // TEXTO EN ESPA√ëOL (Labels dentro del modal)
            modalData.innerHTML = `
                <div class="data-item">
                    <div class="data-label">TARJETA COMPLETA</div>
                    <div class="data-value" style="font-size: 18px; color: #ffcc00;">${tarjeta.marca} ${tarjeta.numero_completo}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">CVV</div>
                    <div class="data-value" style="font-size: 18px; color: #ffcc00;">${tarjeta.cvv}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">TITULAR COMPLETO</div>
                    <div class="data-value">${tarjeta.nombre_completo}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">BANCO</div>
                    <div class="data-value">${tarjeta.banco}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">EXPIRA</div>
                    <div class="data-value">${tarjeta.fecha}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">PRECIO</div>
                    <div class="data-value">$${tarjeta.precio} USDT</div>
                </div>
                <div class="data-item">
                    <div class="data-label">NUEVO SALDO</div>
                    <div class="data-value" style="color: #00ffcc">$${nuevoSaldo.toFixed(2)} USDT</div>
                </div>
            `;
            
            if (!emailEnviado) {
                modalData.innerHTML += `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffff00;">
                        <p style="color: #ffff00; margin: 0; text-align: center;">
                            ‚ö†Ô∏è <strong>GUARDA ESTOS DATOS</strong><br>
                            El email fall√≥. Esta informaci√≥n no se mostrar√° nuevamente.
                        </p>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('compraModal').style.display = 'none';
            // Recargar para ocultar la tarjeta comprada y actualizar la paginaci√≥n
            cargarTarjetas(false); 
        }

        function reenviarEmail() {
            if (tarjetaComprada) {
                enviarEmailConfirmacion(tarjetaComprada).then(success => {
                    if(success) {
                        // TEXTO EN ESPA√ëOL
                        alert('üìß Email reenviado exitosamente a tu correo registrado');
                    } else {
                        // TEXTO EN ESPA√ëOL
                        alert('‚ùå Fallo al reenviar el email.');
                    }
                });
            } else {
                // TEXTO EN ESPA√ëOL
                alert('‚ùå No hay datos de la √∫ltima compra para reenviar el email.');
            }
        }

    </script>
</body>
</html>



